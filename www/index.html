<!DOCTYPE html>
<html>
<head>
	<style>
		canvas {
			border:1px solid #000000;
		}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script>
		var grid_size = 20;
		var grid_count_width = 30;
		var grid_count_height = 24;
		var update_interval = 300;
		
		var myCanvas, ctx;
		var live_objects = new Array();
		
		//live_objects.push({color:"#000000",x_coord:"0",y_coord:"0"});
		//live_objects.push({color:"#000000",x_coord:"100",y_coord:"100"});
		
		window.addEventListener('load', eventWindowLoaded, false);
		console.log(window.location.href);
		
		function eventWindowLoaded () {
		  canvasApp();
		  var v = setInterval(update, update_interval);
		}
		
		function canvasSupport (e) {
			return !!e.getContext;
		}
				
		function canvasApp () {		
		  myCanvas = document.getElementById('myCanvas');
		  ctx = myCanvas.getContext('2d');

		  if (!canvasSupport(myCanvas)) {
			  return; 
			}
  
		  myCanvas.width = grid_size * grid_count_width;
		  myCanvas.height = grid_size * grid_count_height;
  
  		  myCanvas.addEventListener('click', function(event) {
  		  		drawElement(event);
  		  }, false); 
  		  
  		  myCanvas.addEventListener('touchend', function(event) {
  			  drawElement(event);
  		  }, false);
  		  
		  drawScreen();
		}
		
		function drawScreen() {
	
			var x = 0;
			var y = 0;
			var w = myCanvas.width;
			var h = myCanvas.height;
	
			ctx.lineWidth = 1;
	
			while (y < h) {
			  y = y + grid_size;
			  ctx.moveTo(x, y);
			  ctx.lineTo(w, y);
			  ctx.stroke();
			}
	
			y =0;  

			while (x < w) {
			  x = x + grid_size;
			  ctx.moveTo(x, y);  
			  ctx.lineTo(x,h);  
			  ctx.stroke();    
			}
		}
		
		function drawElement(evt) {
			var mouse_x = evt.offsetX;
			var mouse_y = evt.offsetY;
			
			var x_snap_to_grid = mouse_x - (mouse_x % grid_size);
			var y_snap_to_grid = mouse_y - (mouse_y % grid_size);
			
			$.ajax({
				type: "POST",
				url: window.location.href + "push_change", 
				data: {color:"#000000",x_coord:x_snap_to_grid,y_coord:y_snap_to_grid},
				dataType: 'json',
				success: function(result) {	return; },
				error: function(status, error) {
					console.log("Error: " + status.status + ", " + error);
				}
			});
	
		}
		
		function update() {
			$.ajax({
				type: "POST",
				url: window.location.href + "update",
				data: {'live_objects': JSON.stringify(live_objects)},
				dataType: 'json',
				success: function(result) {
					console.log(result.length);
					for(var i = 0; i < result.length; i++) {
						if(result[i].action=="delete") {
							var index = live_objects.indexOf(result[i].item);
							live_objects.splice(index,1);
							ctx.fillStyle="#FFFFFF";
							ctx.fillRect(result[i].item.x_coord,result[i].item.y_coord,grid_size,grid_size);
							console.log("delete: " + JSON.stringify(result[i].item));
						} else if(result[i].action=="add") {
							live_objects.push(result[i].item);
							ctx.fillStyle=result[i].item.color;
							ctx.fillRect(result[i].item.x_coord,result[i].item.y_coord,grid_size,grid_size);
							console.log("add: " + JSON.stringify(result[i].item));
						}
					}
				},
				error: function(status, error) {
					console.log("Error: " + status.status + ", " + error);
				}
			});
		}
		
		function error_report(status, error) {
			console.log("Error: " + status.status + ", " + error);
		}
	</script>
</head>
<body>
	<canvas id="myCanvas"></canvas>
</body>
</html>
