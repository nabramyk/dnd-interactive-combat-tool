var selected_element,holdTimer,hoverTimer,movementTimer,grid_canvas,ctx,underlay_canvas,ctx2,overlay_canvas,overlay_ctx,temporary_drawing_canvas,temporary_drawing_ctx,socket,grid_size=20,grid_count_width=0,grid_count_height=0,grid_color="rgba(200,200,200,1)",grid_highlight="rgba(0,153,0,1)",grid_line_width=.5,grid_id=0,selected_grid_x=-1,selected_grid_y=-1,cursor_size=1,cursor_line_width=1,movementInterval=100,prehandledByTouchEvent=!1,local_stored_grid_space=[],local_stored_annotations=[],grid_spaces_list=[],x_vertices=[],y_vertices=[],mouse_down=!1,touch_start=!1,copied_element=null;function eventWindowLoaded(){canvasApp()}function canvasSupport(e){return!!e.getContext}function canvasApp(){interfaceInitialization(),canvasSupport(grid_canvas)&&(socket=io(),bindSocketListeners(),bindEventHandlers())}function bindSocketListeners(){socket.on("connect",function(e){$("#lost_connection_div").hide(),socket.emit("init",{},function(e){resizeGridHeight(grid_count_height=e.grid_height),resizeGridWidth(grid_count_width=e.grid_width),clear_prev_cursor_position(),selected_grid_x=-1,selected_grid_y=-1,$("#element_list").empty(),refresh_elements_list(),$(".tab").remove(),grid_id=e.spaces[0].id,$("#grid_name").val(e.spaces[0].name),e.spaces.forEach(function(e){$('<div class="tab"><button class="grid-name" value="'+e.id+'">'+e.name+'</button><button class="grid-space-delete" value="'+e.id+'">&times</button></div>').insertBefore("#addition_tab")}),$(".tab").first().addClass("active"),0!==e.elements.length?(local_stored_grid_space=e.elements,$("#reset_board_button").prop("disabled",!1),drawElements()):local_stored_grid_space=[],local_stored_annotations=e.annotations,showAnnotations(),refresh_annotations_list(),refresh_elements_list(),$("#options_add_or_edit_button").hide(),$("#options_annotate_button").hide(),$("#options_delete_button").hide(),$("#options_copy_button").hide(),$("#options_paste_button").hide(),$("#options_movement_button").hide()})}),socket.on("disconnect",function(){$("#lost_connection_div").show(),$("#lost_connection_text").text("(ง'̀-'́)ง  The server could not be reached")}),socket.on("resize_height",function(e){grid_id==e.grid_id&&(resizeGridHeight(grid_count_height=e.height),local_stored_grid_space=e.elements,drawElements())}),socket.on("resize_width",function(e){grid_id==e.grid_id&&(resizeGridWidth(grid_count_width=e.width),local_stored_grid_space=e.elements,drawElements())}),socket.on("added_element",function(e){e.grid_id==grid_id&&($("#reset_board_button").prop("disabled",!1),ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height),local_stored_grid_space.push(e.element),drawElements(),refresh_elements_list())}),socket.on("added_elements",function(e){e.grid_id==grid_id&&($("#reset_board_button").prop("disabled",!1),ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height),local_stored_grid_space=local_stored_grid_space.concat(e.element),drawElements(),refresh_elements_list())}),socket.on("removed_element",function(e){e.grid_id==grid_id&&(ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height),local_stored_grid_space.splice(local_stored_grid_space.findIndex(function(t){return t.id==e.element_id}),1),drawElements(),$("#reset_board_button").prop("disabled",e.gridSpaceEmpty),refresh_elements_list())}),socket.on("move_element",function(e){e.grid_id==grid_id&&(ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height),local_stored_grid_space[local_stored_grid_space.indexOf(local_stored_grid_space.find(function(t){return e.element.id==t.id}))]=e.element,drawElements(),$("#element_list>#"+e.element.id).replaceWith(composeElementListRowElement(e.element)))}),socket.on("edited_element",function(e){console.log(e),e.grid_id==grid_id&&(ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height),local_stored_grid_space[local_stored_grid_space.indexOf(local_stored_grid_space.find(function(t){return e.element.id==t.id}))]=e.element,drawElements(),$("#element_list>#"+e.element.id).replaceWith(composeElementListRowElement(e.element)))}),socket.on("new_grid_space",function(e){$('<div class="tab"><button class="grid-name" value="'+e.id+'">'+e.name+'</button><button class="grid-space-delete" value="'+e.id+'">&times</button></div>').insertBefore("#addition_tab")}),socket.on("reset_grid",function(e){grid_id==e.grid_id&&(ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height),local_stored_grid_space=[])}),socket.on("delete_grid_space",function(e){$('button[class="grid-space-delete"][value="'+e.grid_id+'"]').parent().remove(),e.grid_id==grid_id&&(alert("Well, someone decided that you don't need to be here anymore."),ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height),socket.emit("init",{}))}),socket.on("renaming_grid",function(e){$('button[class="grid-name"][value="'+e.grid_id+'"]').text(e.grid_name)}),socket.on("added_annotation",function(e){grid_id==e.grid_id&&(local_stored_annotations.push(e.annotation),hideAnnotations(),showAnnotations(),refresh_annotations_list())}),socket.on("deleted_annotation",function(e){grid_id==e.grid_id&&(local_stored_annotations.splice(local_stored_annotations.findIndex(function(t){return t.id==e.annotation_id}),1),refresh_annotations_list())}),socket.on("error_channel",function(e){alert(e.message)})}function bindEventHandlers(){$("#grid_canvas_scrolling_container").scroll(function(){$("#ruler_top_scrolling_container").scrollLeft($("#grid_canvas_scrolling_container").scrollLeft()),$("#ruler_left_scrolling_container").scrollTop($("#grid_canvas_scrolling_container").scrollTop())}),$("#grid_size_vertical").val(grid_count_height),$("#grid_size_horizontal").val(grid_count_width),$("#grid_size_vertical").change(function(){grid_count_height=$("#grid_size_vertical").val(),socket.emit("resize_height",{grid_id:grid_id,height:grid_count_height})}),$("#grid_size_horizontal").change(function(){grid_count_width=$("#grid_size_horizontal").val(),socket.emit("resize_width",{grid_id:grid_id,width:grid_count_width})}),$("#grid_name").change(function(){socket.emit("rename_grid",{grid_id:grid_id,grid_name:$("#grid_name").val()})}),$("#overlay_canvas").mousedown(function(e){canvasClicked(e.offsetX,e.offsetY)}).mousemove(function(e){clearPlayerName(),clearTimeout(hoverTimer),local_stored_grid_space.forEach(function(t){if(gridPoint2Pixel(t.x)<e.offsetX&&gridPoint2Pixel(t.x+t.size)>e.offsetX&&gridPoint2Pixel(t.y)<e.offsetY&&gridPoint2Pixel(t.y+t.size)>e.offsetY){if(prehandledByTouchEvent)return void(prehandledByTouchEvent=!1);showPlayerName(e.offsetX+$("#overlay_canvas").offset().left,e.offsetY+$("#overlay_canvas").offset().top-40,t.name)}})}).mouseleave(function(e){clearPlayerName(),clearTimeout(hoverTimer)}).contextmenu(function(e){if(-1!=selected_grid_x||-1!=selected_grid_y){clearPlayerName(),e.preventDefault();var t=local_stored_grid_space.find(function(t){return gridPoint2Pixel(t.x)<e.offsetX&&gridPoint2Pixel(t.x+t.size)>e.offsetX&&gridPoint2Pixel(t.y)<e.offsetY&&gridPoint2Pixel(t.y+t.size)>e.offsetY});showLongHoldMenu(e.pageX-e.clientX%grid_size-$("#grid_canvas_scrolling_container").scrollLeft()%grid_size+grid_size,e.pageY-e.clientY%grid_size-$("#grid_canvas_scrolling_container").scrollTop()%grid_size+grid_size,isUndefined(t)?-1:t.id)}}).on("touchstart",function(e){prehandledByTouchEvent=!0;var t=e.originalEvent.touches[0].clientX-$("#overlay_canvas").offset().left,i=e.originalEvent.touches[0].clientY-$("#overlay_canvas").offset().top;canvasClicked(t,i);var n=local_stored_grid_space.find(function(e){return gridPoint2Pixel(e.x)<t&&gridPoint2Pixel(e.x+e.size)>t&&gridPoint2Pixel(e.y)<i&&gridPoint2Pixel(e.y+e.size)>i});return holdTimer=window.setTimeout(function(){showLongHoldMenu(t-t%grid_size+grid_size+$("#overlay_canvas").offset().left,i-i%grid_size+$("#overlay_canvas").offset().top,isUndefined(n)?-1:n.id)},1e3),!0}).on("touchend",function(e){return clearTimeout(holdTimer),!1}).on("touchmove",function(e){return clearPlayerName(),clearTimeout(holdTimer),!0}),$("#place_element_button").click(function(){if("Add"===$("#place_element_button").text())switch($("#selected_shape").val()){case"square":case"circle":add_element_to_server($("#element_color").val(),selected_grid_x,selected_grid_y,$("#selected_shape").val(),$("#element_name").val(),$("#element_size").val(),$("#element_category").val());break;case"line":x_vertices.push(selected_grid_x),y_vertices.push(selected_grid_y),1===x_vertices.length&&1===y_vertices.length&&$("#start_new_line_button").toggle()}else console.log($("#element_color").val()),socket.emit("edit_element_on_server",{grid_id:grid_id,id:selected_element.id,name:$("#element_name").val(),shape:$("#selected_shape").val(),color:$("#element_color").val(),size:$("#element_size").val(),category:$("#element_category").val()})}),$("#reset_board_button").click(function(){confirm("This will delete EVERYTHING on the board.\nAre you sure you want to do this?")&&(socket.emit("reset_board",{grid_id:grid_id}),$("#reset_board_button").prop("disabled",!0),refresh_elements_list())}),$("#start_new_line_button").click(function(){temporary_drawing_ctx.clearRect(0,0,temporary_drawing_canvas.width,temporary_drawing_canvas.height),selected_grid_x===x_vertices[x_vertices.length-1]&&selected_grid_y===y_vertices[y_vertices.length-1]||(x_vertices.push(selected_grid_x),y_vertices.push(selected_grid_y)),x_vertices.length>1&&y_vertices.length>1&&add_element_to_server($("#element_color").val(),x_vertices,y_vertices,$("#selected_shape").val(),null,$("#element_size").val(),$("#element_category").val()),x_vertices=[],y_vertices=[],$("#start_new_line_button").toggle()}),$("#move_inc_up").mousedown(function(){incremental_move_element("up"),movementTimer=window.setInterval(function(){incremental_move_element("up")},movementInterval)}).mouseup(function(){console.log("cleared"),window.clearInterval(movementTimer)}),$("#move_inc_down").mousedown(function(){incremental_move_element("down"),movementTimer=setInterval(function(){incremental_move_element("down")},movementInterval)}).mouseup(function(){clearInterval(movementTimer)}),$("#move_inc_left").mousedown(function(){incremental_move_element("left"),movementTimer=setInterval(function(){incremental_move_element("left")},movementInterval)}).mouseup(function(){clearInterval(movementTimer)}),$("#move_inc_right").mousedown(function(){incremental_move_element("right"),movementTimer=setInterval(function(){incremental_move_element("right")},movementInterval)}).mouseup(function(){clearInterval(movementTimer)}),$("#selected_shape").change(function(e){switch($("#selected_shape").val()){case"line":$("#place_element_button").html("Add Vertex");break;case"square":case"circle":$("#place_element_button").html("Add"),$("#start_new_line_button").hide()}if(-1!=selected_grid_x||-1!=selected_grid_y){for(var t=1;t<x_vertices.length;t++)clear_item("line",[x_vertices[t-1],x_vertices[t]],[y_vertices[t-1],y_vertices[t]],{},0);x_vertices.length=[],y_vertices.length=[],clear_prev_cursor_position(),draw_cursor_at_position(selected_grid_x,selected_grid_y)}}),$("#drawing_controls_button").click(function(){$("#drawing_controls").toggle(),$("#movement_controls").hide(),$("#settings_controls").hide(),$("#editing_controls").hide()}),$("#movement_controls_button").click(function(){$("#movement_controls").toggle(),$("#drawing_controls").hide(),$("#settings_controls").hide(),$("#editing_controls").hide()}),$("#settings_controls_button").click(function(){$("#settings_controls").toggle(),$("#drawing_controls").hide(),$("#movement_controls").hide(),$("#editing_controls").hide()}),$("#grid_down").click(function(){$("#grid_space_dropdown").toggle()}),$("#drawing_controls_btn").click(function(){$("#drawing_controls").toggle()}),$("#editing_controls_btn").click(function(){$("#editing_controls").toggle()}),$("#movement_controls_btn").click(function(){$("#movement_controls").toggle()}),$("#settings_controls_btn").click(function(){$("#settings_controls").toggle()}),$("#element_list_btn").click(function(){$("#element_list_dropdown").toggle()}),$("#editing_controls_done").click(function(){socket.emit("edit_element_on_server",{grid_id:grid_id,id:$("#edit_element_id").val(),name:$("#edit_name").val(),type:$("#edit_shape").val(),color:$("#edit_color").val(),size:$("#edit_size").val(),category:$("#edit_category").val()}),removeEditMenu()}),$("#randomize").click(function(){socket.emit("randomize",{grid_id:grid_id})}),$(".element_filter").click(function(){refresh_elements_list()}),$("#addition_tab").click(function(){socket.emit("create_grid_space",{})}),$("#list_header_elements").click(function(){$("#list_header_elements").css("background","#345eb2"),$("#list_header_elements").css("color","white"),$("#list_header_annotations").css("background"," #dddddd"),$("#list_header_annotations").css("color","black"),$("#annotations_list_container").hide(),$("#element_list_container").show()}),$("#list_header_annotations").click(function(){$("#list_header_annotations").css("background","#345eb2"),$("#list_header_annotations").css("color","white"),$("#list_header_elements").css("background"," #dddddd"),$("#list_header_elements").css("color","black"),$("#element_list_container").hide(),$("#annotations_list_container").show()}),$("#annotations_display").change(function(){$(".grid_canvas_annotation").toggle()}),$(document).on("click","#tab_row .grid-name",function(e){$(".tab").removeClass("active"),$(this).parent().addClass("active"),grid_id=$(this).val(),socket.emit("request_grid_space",{id:$(this).val()},function(e){resizeGridHeight(grid_count_height=e.grid_space.height),resizeGridWidth(grid_count_width=e.grid_space.width),clearPlayerName(),local_stored_grid_space=[],local_stored_annotations=[],$("#grid_name").val(e.grid_space.name),0!==e.grid_space.elements.length&&(local_stored_grid_space=e.grid_space.elements,$("#reset_board_button").prop("disabled",!1),drawElements()),0!==e.grid_space.annotations.length&&(local_stored_annotations=e.grid_space.annotations),refresh_elements_list(),refresh_annotations_list(),$("#options_add_or_edit_button").hide(),$("#options_annotate_button").hide(),$("#options_delete_button").hide(),$("#options_copy_button").hide(),$("#options_paste_button").hide(),$("#options_movement_button").hide()})}).on("click","#context_editing_controls_done",function(e){socket.emit("edit_element_on_server",{grid_id:grid_id,id:$("#context_edit_element_id").val(),name:$("#context_edit_name").val(),type:$("#context_edit_shape").val(),color:$("#context_edit_color").val(),size:$("#context_edit_size").val(),category:$("#context_edit_category").val()})}).on("click","#context_annotation_controls_done",function(e){socket.emit("add_annotation_to_server",{grid_id:grid_id,title:"",content:$("#annotation_content").val(),x:selected_grid_x,y:selected_grid_y})}).on("mousedown","#dragging_element_icon",function(e){mouse_down=!0}).on("touchstart","#dragging_element_icon",function(e){touch_start=!0}).mousemove(function(e){mouse_down&&($("#dragging_element_icon").css("top",e.clientY-grid_size/2),$("#dragging_element_icon").css("left",e.clientX-grid_size/2),temporary_drawing_ctx.clearRect(0,0,temporary_drawing_canvas.width,temporary_drawing_canvas.height),draw_temporary_cursor_at_position(e.clientX-e.clientX%grid_size-$("#temporary_drawing_canvas").offset().left+grid_size-$("#grid_canvas_scrolling_container").scrollLeft()%grid_size,e.clientY-e.clientY%grid_size-$("#temporary_drawing_canvas").offset().top+grid_size-$("#grid_canvas_scrolling_container").scrollTop()%grid_size,cursor_size))}).on("touchmove","#dragging_element_icon",function(e){touch_start&&($("#dragging_element_icon").css("top",e.originalEvent.touches[0].clientY-grid_size/2),$("#dragging_element_icon").css("left",e.originalEvent.touches[0].clientX-grid_size/2),temporary_drawing_ctx.clearRect(0,0,temporary_drawing_canvas.width,temporary_drawing_canvas.height),draw_temporary_cursor_at_position(e.originalEvent.touches[0].clientX-e.originalEvent.touches[0].clientX%grid_size-$("#temporary_drawing_canvas").offset().left+grid_size,e.originalEvent.touches[0].clientY-e.originalEvent.touches[0].clientY%grid_size-$("#temporary_drawing_canvas").offset().top+grid_size,cursor_size))}).on("mouseup","#dragging_element_icon",function(e){dragElement(e.clientX,e.clientY,e.pageX,e.pageY),mouse_down=!1}).on("touchend","#dragging_element_icon",function(e){dragElement(e.originalEvent.changedTouches[0].clientX,e.originalEvent.changedTouches[0].clientY,e.originalEvent.changedTouches[0].pageX,e.originalEvent.changedTouches[0].pageY),touch_start=!1}).on("click","#tab_row .grid-space-delete",function(e){confirm("Are you sure you want to delete this board? This action cannot be undone.")&&socket.emit("delete_grid_space_from_server",{grid_id:$(this).val()})}),$("#grid_canvas").focus(),$(document).keydown(function(e){switch(e.which){case 37:e.preventDefault(),$("#move_inc_left").mousedown().mouseup();break;case 38:e.preventDefault(),$("#move_inc_up").mousedown().mouseup();break;case 39:e.preventDefault(),$("#move_inc_right").mousedown().mouseup();break;case 40:e.preventDefault(),$("#move_inc_down").mousedown().mouseup()}}),$("#overlapping_container_tab").click(function(e){$("#side_container_swap > *").hide(),$("#options_container").show(),$("#overlapping_side_container").show(),$("#overlapping_back_button").hide(),$(".drawing_canvas").css("padding-right","block"==$("#overlapping_side_container").css("display")?"500px":"300px"),$("#tab_row").css("padding-right","block"==$("#overlapping_side_container").css("display")?"200px":"0px")}),$("#overlapping_back_button").click(function(e){$("#overlapping_back_button").hide(),getContextMenu()})}function interfaceInitialization(){grid_canvas=document.getElementById("grid_canvas"),underlay_canvas=document.getElementById("underlay_canvas"),overlay_canvas=document.getElementById("overlay_canvas"),temporary_drawing_canvas=document.getElementById("temporary_drawing_canvas"),start_new_line_button=document.getElementById("start_new_line_button"),$("#movement_controls").hide(),$("#reset_board_button").prop("disabled",!0),$("#start_new_line_button").hide(),$("#lost_connection_div").hide(),ctx=grid_canvas.getContext("2d"),ctx2=underlay_canvas.getContext("2d"),overlay_ctx=overlay_canvas.getContext("2d"),temporary_drawing_ctx=temporary_drawing_canvas.getContext("2d"),grid_canvas.width=grid_size*grid_count_width+2*grid_line_width,grid_canvas.height=grid_size*grid_count_height+2*grid_line_width,underlay_canvas.width=grid_size*grid_count_width+2*grid_line_width,underlay_canvas.height=grid_size*grid_count_height+2*grid_line_width,overlay_canvas.width=grid_size*grid_count_width+2*grid_line_width,overlay_canvas.height=grid_size*grid_count_height+2*grid_line_width,temporary_drawing_canvas.width=grid_size*grid_count_width+2*grid_line_width,temporary_drawing_canvas.height=grid_size*grid_count_height+2*grid_line_width,drawTopRuler(),drawLeftRuler(),drawScreen()}function incremental_move_element(e){socket.emit("move_element",{grid_id:grid_id,x:selected_grid_x,y:selected_grid_y,direction:e,size:cursor_size},function(e){clear_prev_cursor_position(),draw_cursor_at_position(e.x,e.y,e.size)})}function canvasClicked(e,t){$("#dragging_element_icon").remove(),selected_element=null;var i=local_stored_grid_space.find(function(i){return gridPoint2Pixel(i.x)<e&&gridPoint2Pixel(i.x+i.size)>e&&gridPoint2Pixel(i.y)<t&&gridPoint2Pixel(i.y+i.size)>t});if(isUndefined(i)?(cursor_size=1,selected_grid_x=pixel2GridPoint(e-e%grid_size),selected_grid_y=pixel2GridPoint(t-t%grid_size)):(cursor_size=i.size,selected_grid_x=i.x,selected_grid_y=i.y,selected_element=i),clear_prev_cursor_position(),x_vertices.length>0&&y_vertices.length){temporary_drawing_ctx.clearRect(0,0,temporary_drawing_canvas.width,temporary_drawing_canvas.height);var n=x_vertices.slice(0),o=y_vertices.slice(0);n.push(selected_grid_x),o.push(selected_grid_y),draw_temporary_item({type:"line",x:n,y:o,color:$("#element_color").val,size:3})}draw_cursor_at_position(selected_grid_x,selected_grid_y,cursor_size),updateSideMenuContent()}function drawScreen(){ctx2.lineWidth=grid_line_width,ctx2.strokeStyle=grid_color;for(var e=0;e<grid_count_height;e++)for(var t=0;t<grid_count_width;t++)ctx2.strokeRect(t*grid_size+grid_line_width,e*grid_size+grid_line_width,grid_size,grid_size)}function draw_item(e){switch(e.shape){case"square":case"rectangle":ctx.fillStyle="#"+e.color,x=gridPoint2Pixel(e.x)+2*grid_line_width,y=gridPoint2Pixel(e.y)+2*grid_line_width,ctx.fillRect(x+cursor_line_width/2,y+cursor_line_width/2,e.size*grid_size-2*cursor_line_width,e.size*grid_size-2*cursor_line_width);break;case"circle":case"oval":ctx.fillStyle="#"+e.color,x=gridPoint2Pixel(e.x)+grid_line_width,y=gridPoint2Pixel(e.y)+grid_line_width,ctx.beginPath(),ctx.arc(x+grid_size/2*e.size,y+grid_size/2*e.size,e.size*(grid_size/2)-grid_line_width,0,2*Math.PI),ctx.fill();break;case"line":ctx.strokeStyle="#"+e.color,ctx.lineWidth=e.size,ctx.beginPath(),x=e.x.map(function(e){return gridPoint2Pixel(e)}),y=e.y.map(function(e){return gridPoint2Pixel(e)}),ctx.moveTo(x[0]+grid_line_width,y[0]+grid_line_width);for(var t=1;t<x.length;t++)ctx.lineTo(x[t]+grid_line_width,y[t]+grid_line_width);ctx.stroke()}}function draw_temporary_item(e){switch(e.type){case"square":temporary_drawing_ctx.fillStyle="#"+e.color,x=gridPoint2Pixel(e.x)+2*grid_line_width,y=gridPoint2Pixel(e.y)+2*grid_line_width,temporary_drawing_ctx.fillRect(x+cursor_line_width/2,y+cursor_line_width/2,e.size*grid_size-2*cursor_line_width,e.size*grid_size-2*cursor_line_width);break;case"circle":temporary_drawing_ctx.fillStyle="#"+e.color,x=gridPoint2Pixel(e.x)+grid_line_width,y=gridPoint2Pixel(e.y)+grid_line_width,temporary_drawing_ctx.beginPath(),temporary_drawing_ctx.arc(x+grid_size/2*e.size,y+grid_size/2*e.size,e.size*(grid_size/2)-grid_line_width,0,2*Math.PI),temporary_drawing_ctx.fill();break;case"line":temporary_drawing_ctx.strokeStyle="#"+e.color,temporary_drawing_ctx.lineWidth=e.size,temporary_drawing_ctx.beginPath(),x=e.x.map(function(e){return gridPoint2Pixel(e)}),y=e.y.map(function(e){return gridPoint2Pixel(e)}),temporary_drawing_ctx.moveTo(x[0]+grid_line_width,y[0]+grid_line_width);for(var t=1;t<x.length;t++)temporary_drawing_ctx.lineTo(x[t]+grid_line_width,y[t]+grid_line_width);temporary_drawing_ctx.stroke()}}function clear_prev_cursor_position(){overlay_ctx.clearRect(0,0,overlay_canvas.width,overlay_canvas.height),-1!==selected_grid_x&&-1!==selected_grid_y&&(overlay_ctx.strokeStyle=grid_color,overlay_ctx.lineWidth=grid_line_width,overlay_ctx.clearRect(gridPoint2Pixel(selected_grid_x),gridPoint2Pixel(selected_grid_y),cursor_size*grid_size+cursor_line_width,cursor_size*grid_size+cursor_line_width))}function draw_cursor_at_position(e,t,i){switch(selected_grid_x=e,selected_grid_y=t,$("#selected_shape").val()){case"square":case"circle":overlay_ctx.lineWidth=cursor_line_width,overlay_ctx.strokeStyle=grid_highlight,overlay_ctx.strokeRect(gridPoint2Pixel(selected_grid_x)+grid_line_width,gridPoint2Pixel(selected_grid_y)+grid_line_width,grid_size*i,grid_size*i),cursor_size=i;break;case"line":overlay_ctx.fillStyle=grid_highlight,overlay_ctx.beginPath(),overlay_ctx.arc(gridPoint2Pixel(selected_grid_x)+grid_line_width,gridPoint2Pixel(selected_grid_y)+grid_line_width,5,0,2*Math.PI),overlay_ctx.fill()}$("#move_to_x").val(selected_grid_x),$("#move_to_y").val(selected_grid_y)}function draw_temporary_cursor_at_position(e,t,i){switch($("#selected_shape").val()){case"square":case"circle":temporary_drawing_ctx.lineWidth=cursor_line_width,temporary_drawing_ctx.strokeStyle="#b38f00",temporary_drawing_ctx.strokeRect(e+grid_line_width,t+grid_line_width,grid_size*i,grid_size*i),cursor_size=i;break;case"line":temporary_drawing_ctx.fillStyle=grid_highlight,temporary_drawing_ctx.beginPath(),temporary_drawing_ctx.arc(gridPoint2Pixel(selected_grid_x)+grid_line_width,gridPoint2Pixel(selected_grid_y)+grid_line_width,5,0,2*Math.PI),temporary_drawing_ctx.fill()}}function resizeGridWidth(e){grid_count_width=e,$("#grid_size_horizontal").val(grid_count_width),grid_canvas.width=grid_size*grid_count_width+2*grid_line_width,underlay_canvas.width=grid_size*grid_count_width+2*grid_line_width,overlay_canvas.width=grid_size*grid_count_width+2*grid_line_width,temporary_drawing_canvas.width=grid_size*grid_count_width+2*grid_line_width,drawScreen(),drawTopRuler()}function resizeGridHeight(e){grid_count_height=e,$("#grid_size_vertical").val(grid_count_height),grid_canvas.height=grid_size*grid_count_height+2*grid_line_width,underlay_canvas.height=grid_size*grid_count_height+2*grid_line_width,overlay_canvas.height=grid_size*grid_count_height+2*grid_line_width,temporary_drawing_canvas.height=grid_size*grid_count_height+2*grid_line_width,drawScreen(),drawLeftRuler()}function add_element_to_server(e,t,i,n,o,r,_){socket.emit("add_element_to_server",{grid_id:grid_id,color:e,x:JSON.stringify(t),y:JSON.stringify(i),shape:n,name:o,size:r,category:_})}function error_report(e,t){console.log("Error: "+e.status+", "+t)}function refresh_elements_list(){for(var e=document.querySelectorAll(".element_filter:checked"),t=[],i=0;i<=e.length-1;i++)t[i]=e[i].value;0!==e.length?($("#element_list").empty(),local_stored_grid_space.filter(function(e){return-1!=t.indexOf(e.category)}).forEach(function(e){$("#element_list").append(composeElementListRowElement(e))})):$("#element_list").empty()}function refresh_annotations_list(){$("#annotations_list").empty(),local_stored_annotations.forEach(function(e){$("#annotations_list").append(composeAnnotationListRowElement(e))}),hideAnnotations(),showAnnotations(),$(".grid_canvas_annotation").toggle(!1)}function composeElementListRowElement(e){return'<div class="element_list_row" onclick="clicked_element_list('+e.id+')" id='+e.id+'><div style="width: 25%; display: inline-block;"><p style="font-size: smaller;">'+e.name+'<p></div><div style="width: 35%; display: inline-block;"><p style="font-size: smaller;">'+e.category+'<p></div><button id="element_row_edit" onClick="editElementRow('+e.id+')">&#x270E;</button><button id="element_row_delete" onclick="delete_element_from_server('+e.id+')">&times</button></div>'}function composeAnnotationListRowElement(e){return'<div class="element_list_row" onclick="clicked_annotation_list('+e.id+')"><p>'+e.content+'<p><button id="element_row_edit" onClick="editAnnotationRow('+e.id+')">&#x270E;</button><button id="element_row_delete" onclick="delete_annotation_from_server('+e.id+')">&times</button></div>'}function showLongHoldMenu(e,t,i){-1!=i&&$("body").append('<span id="dragging_element_icon" class="glyphicon popup_items" style="position:absolute;top:'+(t-grid_size)+"px;left:"+(e-2*grid_size)+"px;width:"+grid_size+"px;height:"+grid_size+'px;font-size: 18px;">&#xe068;</span>'),getContextMenu()}function getContextMenu(){$("#overlapping_back_button").hide(),$("#side_container_swap > *").hide(),$("#options_container").show(),$("#overlapping_side_container").show(),$(".drawing_canvas").css("padding-right","block"==$("#overlapping_side_container").css("display")?"500px":"300px"),$("#tab_row").css("padding-right","block"==$("#overlapping_side_container").css("display")?"500px":"0")}function editElementRow(e){selected_element=local_stored_grid_space.find(function(t){return t.id==e}),$("#overlapping_container").hide(),$("#add_container").show(),$("#selected_shape").val(selected_element.shape),$("#element_color").val(selected_element.color),$("#element_color_changer")[0].jscolor.fromString(selected_element.color),$("#element_size").val(selected_element.size),$("#element_category").val(selected_element.category),$("#element_name").val(selected_element.name),$("#vertices_list").empty(),"line"===selected_element.shape&&selected_element.x.forEach(function(e,t){$("#vertices_list").append("<p>"+selected_element.x[t]+","+selected_element.y[t]+"</p>")}),$("#place_element_button").text("Submit")}function editAnnotationRow(e){}function showPlayerName(e,t,i){$("body").append('<div id="popup_name" class="popup_items" style="top:'+t+"px; left:"+e+'px"><p>'+i+"</p></div>")}function clearPlayerName(){$("#popup_name").remove()}function clicked_element_list(e){socket.emit("select_element_from_list",{id:e,selected_grid_x:selected_grid_x,selected_grid_y:selected_grid_y,size:cursor_size})}function clicked_annotation_list(e){var t=local_stored_annotations.find(function(t){return t.id==e});clear_prev_cursor_position(),draw_cursor_at_position(t.x,t.y,1)}function delete_element_from_server(e){socket.emit("delete_element_on_server",{grid_id:grid_id,element_id:e})}function delete_annotation_from_server(e){socket.emit("delete_annotation_from_server",{grid_id:grid_id,annotation_id:e})}function drawTopRuler(){var e=document.getElementById("ruler_top");e.width=grid_size*grid_count_width+2*grid_line_width,e.height=grid_size;var t=e.getContext("2d");t.font="10px Arial";for(var i=0;i<grid_count_width;i++){var n=t.measureText(i).width/2;t.fillText(i+1,grid_line_width+grid_size*i+grid_size/2-n,grid_size/1.5)}}function drawLeftRuler(){var e=document.getElementById("ruler_left");e.height=grid_size*grid_count_height+2*grid_line_width,e.width=grid_size;var t=e.getContext("2d");t.font="10px Arial";for(var i=0;i<grid_count_height;i++){var n=t.measureText(i).width;t.fillText(i+1,0,10+grid_line_width+grid_size*i+grid_size/2-n)}}function drawElements(){local_stored_grid_space.forEach(function(e){draw_item(e)})}function dragElement(e,t,i,n){socket.emit("warp_element",{grid_id:grid_id,x:selected_grid_x,y:selected_grid_y,dest_x:pixel2GridPoint(e-e%grid_size-$("#temporary_drawing_canvas").offset().left+grid_size),dest_y:pixel2GridPoint(t-t%grid_size-$("#temporary_drawing_canvas").offset().top+grid_size)},function(e){clear_prev_cursor_position(),draw_cursor_at_position(e.x,e.y,e.size)}),$("#dragging_element_icon").css("top",n-t%grid_size),$("#dragging_element_icon").css("left",i-e%grid_size),temporary_drawing_ctx.clearRect(0,0,temporary_drawing_canvas.width,temporary_drawing_canvas.height),clear_prev_cursor_position(),draw_cursor_at_position(pixel2GridPoint(e-e%grid_size-$("#temporary_drawing_canvas").offset().left+grid_size),pixel2GridPoint(t-t%grid_size-$("#temporary_drawing_canvas").offset().top+grid_size),cursor_size)}function showAnnotations(){local_stored_annotations.forEach(function(e){$("#grid_canvas_scrolling_container").append('<span class="grid_canvas_annotation" style="position: absolute; top: '+(gridPoint2Pixel(e.y)+$("#temporary_drawing_canvas").offset().top)+"px; left: "+(gridPoint2Pixel(e.x)+$("#temporary_drawing_canvas").offset().left)+'px; z-index: 2;">&#x2139;</span>')}),$("#annotations_display").attr("checked")||$(".grid_canvas_annotations").hide()}function hideAnnotations(){$("#grid_canvas_scrolling_container .grid_canvas_annotation").remove()}function selectedMenuOption(e){switch(e){case"lists":$("#overlapping_back_button").show(),$("#options_container").hide(),$("#overlapping_container").show();break;case"grid_space":$("#overlapping_back_button").show(),$("#options_container").hide(),$("#grid_space_container").show();break;case"add_or_edit":$("#overlapping_back_button").show(),$("#options_container").hide(),$("#add_container").show();var t="Add"===$("#options_add_or_edit_button").text();$("#selected_shape").val(t?"square":selected_element.shape),$("#element_color").val(t?"000000":selected_element.color),$("#element_color_changer")[0].jscolor.fromString(t?"#000000":"#"+selected_element.color),$("#element_size").val(t?1:selected_element.size),$("#element_category").val(t?"environment":selected_element.category),$("#element_name").val(t?"object":selected_element.name),$("#place_element_button").text(t?"Add":"Submit");break;case"movement":$("#overlapping_back_button").show(),$("#options_container").hide(),$("#movement_container").show();break;case"copy":(copied_element=local_stored_grid_space.find(function(e){return e.x==selected_grid_x&&e.y==selected_grid_y})).grid_id=grid_id;break;case"paste":add_element_to_server(copied_element.color,selected_grid_x,selected_grid_y,copied_element.shape,copied_element.name,copied_element.size,copied_element.category);break;case"close":$("#overlapping_side_container").hide(),$(".drawing_canvas").css("padding-right","block"==$("#overlapping_side_container").css("display")?"500px":"300px"),$("#tab_row").css("padding-right","block"==$("#overlapping_side_container").css("display")?"200px":"0px");break;case"delete":socket.emit("delete_element_on_server",{grid_id:grid_id,element_id:selected_element.id});break;case"annotate":$("#overlapping_back_button").show(),$("#options_container").hide(),$("#annotations_container").show()}}function updateSideMenuContent(){$("#options_add_or_edit_button").show(),null===selected_element?($("#options_add_or_edit_button").text("Add"),$("#options_copy_button").hide(),$("#options_paste_button").hide(),$("#options_delete_button").hide(),$("#options_movement_button").hide()):($("#options_add_or_edit_button").text("Edit"),$("#options_copy_button").show(),$("#options_paste_button").show(),$("#options_delete_button").show(),$("#options_movement_button").show()),null===copied_element?$("#options_paste_button").hide():$("#options_paste_button").show(),$("#options_annotate_button").show()}function pixel2GridPoint(e){return 1+(e-e%grid_size)/grid_size}function gridPoint2Pixel(e){return(e-1)*grid_size}function isUndefined(e){return void 0===e}window.addEventListener("load",eventWindowLoaded,!1);