function bindSocketListeners(){socket.on("connect",function(msg){$("#lost_connection_div").hide();socket.emit("init",{},function(msg){grid_count_height=msg.grid_height;resizeGridHeight(grid_count_height);grid_count_width=msg.grid_width;resizeGridWidth(grid_count_width);clear_prev_cursor_position();selected_grid_x=-1;selected_grid_y=-1;$("#element_list").empty();refresh_elements_list();$(".tab").remove();grid_id=msg.spaces[0].id;$("#grid_name").val(msg.spaces[0].name);msg.spaces.forEach(function(el){$('<div class="tab"><button class="grid-name" value="'+el.id+'">'+el.name+'</button><button class="grid-space-delete" value="'+el.id+'">&times</button></div>').insertBefore("#addition_tab")});$(".tab").first().addClass("active");if(msg.elements.length!==0){local_stored_grid_space=msg.elements;$("#reset_board_button").prop("disabled",false);drawElements()}else{local_stored_grid_space=[]}local_stored_annotations=msg.annotations;showAnnotations();refresh_annotations_list();refresh_elements_list();$("#options_add_or_edit_button").hide();$("#options_annotate_button").hide();$("#options_delete_button").hide();$("#options_copy_button").hide();$("#options_paste_button").hide();$("#options_movement_button").hide();$("#loading_div").hide()})});socket.on("disconnect",function(){$("#lost_connection_div").show();$("#lost_connection_text").text("(ง'̀-'́)ง  The server could not be reached")});socket.on("resize_height",function(msg){if(grid_id!=msg.grid_id)return;grid_count_height=msg.height;resizeGridHeight(grid_count_height);local_stored_grid_space=msg.elements;drawElements()});socket.on("resize_width",function(msg){if(grid_id!=msg.grid_id)return;grid_count_width=msg.width;resizeGridWidth(grid_count_width);local_stored_grid_space=msg.elements;drawElements()});socket.on("added_element",function(msg){if(msg.grid_id!=grid_id)return;if(msg.element.category=="ping"){drawPing(msg.element,msg.grid_id);return}$("#reset_board_button").prop("disabled",false);ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height);local_stored_grid_space.push(msg.element);drawElements();refresh_elements_list()});socket.on("added_elements",function(msg){if(msg.grid_id!=grid_id)return;$("#reset_board_button").prop("disabled",false);ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height);local_stored_grid_space=local_stored_grid_space.concat(msg.element);drawElements();refresh_elements_list()});socket.on("removed_element",function(msg){if(msg.grid_id!=grid_id)return;ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height);local_stored_grid_space.splice(local_stored_grid_space.findIndex(function(el){return el.id==msg.element_id}),1);drawElements();$("#reset_board_button").prop("disabled",msg.gridSpaceEmpty);refresh_elements_list()});socket.on("move_element",function(msg){if(msg.grid_id!=grid_id)return;ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height);local_stored_grid_space[local_stored_grid_space.indexOf(local_stored_grid_space.find(function(el){return msg.element.id==el.id}))]=msg.element;drawElements();$("#element_list>#"+msg.element.id).replaceWith(composeElementListRowElement(msg.element))});socket.on("edited_element",function(msg){console.log(msg);if(msg.grid_id!=grid_id)return;ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height);local_stored_grid_space[local_stored_grid_space.indexOf(local_stored_grid_space.find(function(el){return msg.element.id==el.id}))]=msg.element;drawElements();$("#element_list>#"+msg.element.id).replaceWith(composeElementListRowElement(msg.element))});socket.on("new_grid_space",function(msg){$('<div class="tab"><button class="grid-name" value="'+msg.id+'">'+msg.name+'</button><button class="grid-space-delete" value="'+msg.id+'">&times</button></div>').insertBefore("#addition_tab")});socket.on("reset_grid",function(msg){if(grid_id!=msg.grid_id)return;ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height);local_stored_grid_space=[]});socket.on("delete_grid_space",function(msg){$('button[class="grid-space-delete"][value="'+msg.grid_id+'"]').parent().remove();if(msg.grid_id==grid_id){alert("Well, someone decided that you don't need to be here anymore.");ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height);socket.emit("init",{})}});socket.on("renaming_grid",function(msg){$('button[class="grid-name"][value="'+msg.grid_id+'"]').text(msg.grid_name)});socket.on("added_annotation",function(msg){if(grid_id!=msg.grid_id)return;local_stored_annotations.push(msg.annotation);hideAnnotations();showAnnotations();refresh_annotations_list()});socket.on("deleted_annotation",function(msg){if(grid_id!=msg.grid_id)return;local_stored_annotations.splice(local_stored_annotations.findIndex(function(el){return el.id==msg.annotation_id}),1);refresh_annotations_list()});socket.on("error_channel",function(msg){alert(msg.message)})}function add_element_to_server(color,x,y,shape,name,size,category){socket.emit("add_element_to_server",{grid_id:grid_id,color:color,x:JSON.stringify(x),y:JSON.stringify(y),shape:shape,name:name,size:size,category:category,rotation:1})}function pingPosition(){add_element_to_server("",selected_grid_x,selected_grid_y,"","","","ping")}function dragElement(client_x,client_y,page_x,page_y){socket.emit("warp_element",{grid_id:grid_id,x:selected_grid_x,y:selected_grid_y,dest_x:pixel2GridPoint(client_x-client_x%grid_size-$("#temporary_drawing_canvas").offset().left+grid_size),dest_y:pixel2GridPoint(client_y-client_y%grid_size-$("#temporary_drawing_canvas").offset().top+grid_size)},function(msg){clear_prev_cursor_position();draw_cursor_at_position(msg.x,msg.y,msg.size)});$("#dragging_element_icon").css("top",page_y-client_y%grid_size);$("#dragging_element_icon").css("left",page_x-client_x%grid_size);temporary_drawing_ctx.clearRect(0,0,temporary_drawing_canvas.width,temporary_drawing_canvas.height);clear_prev_cursor_position();draw_cursor_at_position(pixel2GridPoint(client_x-client_x%grid_size-$("#temporary_drawing_canvas").offset().left+grid_size),pixel2GridPoint(client_y-client_y%grid_size-$("#temporary_drawing_canvas").offset().top+grid_size),cursor_size)}function delete_element_from_server(id){socket.emit("delete_element_on_server",{grid_id:grid_id,element_id:id})}function delete_annotation_from_server(id){socket.emit("delete_annotation_from_server",{grid_id:grid_id,annotation_id:id})}function incremental_move_element(direction){socket.emit("move_element",{grid_id:grid_id,x:selected_grid_x,y:selected_grid_y,direction:direction,size:cursor_size},function(msg){clear_prev_cursor_position();draw_cursor_at_position(msg.x,msg.y,msg.size)})}function refresh_annotations_list(){$("#annotations_list").empty();local_stored_annotations.forEach(function(el){$("#annotations_list").append(composeAnnotationListRowElement(el))});hideAnnotations();showAnnotations();$(".grid_canvas_annotation").toggle(false)}function editAnnotationRow(id){}function drawTopRuler(){var ruler_top=document.getElementById("ruler_top");ruler_top.width=grid_size*grid_count_width+2*grid_line_width;ruler_top.height=grid_size;var ctx2=ruler_top.getContext("2d");ctx2.font="10px Arial";for(var i=0;i<grid_count_width;i++){var n=ctx2.measureText(i).width/2;ctx2.fillText(i+1,grid_line_width+grid_size*i+grid_size/2-n,grid_size/1.5)}}function drawLeftRuler(){var ruler_left=document.getElementById("ruler_left");ruler_left.height=grid_size*grid_count_height+2*grid_line_width;ruler_left.width=grid_size;var ctx2=ruler_left.getContext("2d");ctx2.font="10px Arial";for(var i=0;i<grid_count_height;i++){var n=ctx2.measureText(i).width;ctx2.fillText(i+1,0,10+grid_line_width+grid_size*i+grid_size/2-n)}}function drawElements(){local_stored_grid_space.forEach(function(el){draw_item(el)});local_stored_pings.forEach(function(el){ctx.save();ctx.fillStyle="#"+el.color;var x=gridPoint2Pixel(el.x)+grid_line_width;var y=gridPoint2Pixel(el.y)+grid_line_width;ctx.beginPath();ctx.globalAlpha=el.opacity;ctx.arc(x+grid_size/2*el.size,y+grid_size/2*el.size,el.size*(grid_size/2)-grid_line_width,0,2*Math.PI);ctx.fill();ctx.restore()})}function draw_item(element){ctx.save();switch(element.shape){case"square":case"rectangle":ctx.fillStyle="#"+element.color;x=gridPoint2Pixel(element.x)+grid_line_width*2;y=gridPoint2Pixel(element.y)+grid_line_width*2;ctx.fillRect(x+cursor_line_width/2,y+cursor_line_width/2,JSON.parse(element.size.width)*grid_size-cursor_line_width*2,JSON.parse(element.size.height)*grid_size-cursor_line_width*2);if(element.rotation!=0){ctx.beginPath();console.log(element);switch(element.rotation){case 1:x+=JSON.parse(element.size.width)*grid_size-2;y+=JSON.parse(element.size.height)*grid_size/2;break;case 2:x+=JSON.parse(element.size.width)*grid_size/2;y+=2;break;case 3:x+=2;y+=JSON.parse(element.size.height)*grid_size/2;break;case 4:x+=JSON.parse(element.size.width)*grid_size/2;y+=JSON.parse(element.size.height)*grid_size-2;break}ctx.fillStyle="#FFFFFF";ctx.arc(y,x,2,0,2*Math.PI);ctx.fill()}break;case"circle":case"oval":ctx.fillStyle="#"+element.color;x=gridPoint2Pixel(element.x)+grid_line_width;y=gridPoint2Pixel(element.y)+grid_line_width;ctx.beginPath();ctx.arc(x+grid_size/2*element.size,y+grid_size/2*element.size.width,element.size.height*(grid_size/2)-grid_line_width,0,2*Math.PI);ctx.fill();break;case"line":ctx.strokeStyle="#"+element.color;ctx.lineWidth=element.size;ctx.beginPath();x=element.x.map(function(e){return gridPoint2Pixel(e)});y=element.y.map(function(e){return gridPoint2Pixel(e)});ctx.moveTo(x[0]+grid_line_width,y[0]+grid_line_width);for(var i=1;i<x.length;i++){ctx.lineTo(x[i]+grid_line_width,y[i]+grid_line_width)}ctx.stroke();break}ctx.restore()}function draw_temporary_item(element){switch(element.type){case"square":temporary_drawing_ctx.fillStyle="#"+element.color;x=gridPoint2Pixel(element.x)+grid_line_width*2;y=gridPoint2Pixel(element.y)+grid_line_width*2;temporary_drawing_ctx.fillRect(x+cursor_line_width/2,y+cursor_line_width/2,element.size*grid_size-cursor_line_width*2,element.size*grid_size-cursor_line_width*2);break;case"circle":temporary_drawing_ctx.fillStyle="#"+element.color;x=gridPoint2Pixel(element.x)+grid_line_width;y=gridPoint2Pixel(element.y)+grid_line_width;temporary_drawing_ctx.beginPath();temporary_drawing_ctx.arc(x+grid_size/2*element.size,y+grid_size/2*element.size,element.size*(grid_size/2)-grid_line_width,0,2*Math.PI);temporary_drawing_ctx.fill();break;case"line":temporary_drawing_ctx.strokeStyle="#"+element.color;temporary_drawing_ctx.lineWidth=element.size;temporary_drawing_ctx.beginPath();x=element.x.map(function(e){return gridPoint2Pixel(e)});y=element.y.map(function(e){return gridPoint2Pixel(e)});temporary_drawing_ctx.moveTo(x[0]+grid_line_width,y[0]+grid_line_width);for(var i=1;i<x.length;i++){temporary_drawing_ctx.lineTo(x[i]+grid_line_width,y[i]+grid_line_width)}temporary_drawing_ctx.stroke();break}}function clear_prev_cursor_position(){overlay_ctx.clearRect(0,0,overlay_canvas.width,overlay_canvas.height);if(selected_grid_x===-1||selected_grid_y===-1)return;overlay_ctx.strokeStyle=grid_color;overlay_ctx.lineWidth=grid_line_width;overlay_ctx.clearRect(gridPoint2Pixel(selected_grid_x),gridPoint2Pixel(selected_grid_y),cursor_size*grid_size+cursor_line_width,cursor_size*grid_size+cursor_line_width)}function draw_cursor_at_position(x,y,size){selected_grid_x=x;selected_grid_y=y;switch($("#selected_shape").val()){case"line":overlay_ctx.fillStyle=grid_highlight;overlay_ctx.beginPath();overlay_ctx.arc(gridPoint2Pixel(selected_grid_x)+grid_line_width,gridPoint2Pixel(selected_grid_y)+grid_line_width,5,0,2*Math.PI);overlay_ctx.fill();break;default:overlay_ctx.lineWidth=cursor_line_width;overlay_ctx.strokeStyle=grid_highlight;overlay_ctx.strokeRect(gridPoint2Pixel(selected_grid_x)+grid_line_width,gridPoint2Pixel(selected_grid_y)+grid_line_width,grid_size*size.width,grid_size*size.height);cursor_size=size}$("#move_to_x").val(selected_grid_x);$("#move_to_y").val(selected_grid_y)}function draw_temporary_cursor_at_position(x,y,size){switch($("#selected_shape").val()){case"square":case"circle":temporary_drawing_ctx.lineWidth=cursor_line_width;temporary_drawing_ctx.strokeStyle="#b38f00";temporary_drawing_ctx.strokeRect(x+grid_line_width,y+grid_line_width,grid_size*size,grid_size*size);cursor_size=size;break;case"line":temporary_drawing_ctx.fillStyle=grid_highlight;temporary_drawing_ctx.beginPath();temporary_drawing_ctx.arc(gridPoint2Pixel(selected_grid_x)+grid_line_width,gridPoint2Pixel(selected_grid_y)+grid_line_width,5,0,2*Math.PI);temporary_drawing_ctx.fill()}}function drawScreen(){ctx2.lineWidth=grid_line_width;ctx2.strokeStyle=grid_color;for(var i=0;i<grid_count_height;i++){for(var j=0;j<grid_count_width;j++){ctx2.strokeRect(j*grid_size+grid_line_width,i*grid_size+grid_line_width,grid_size,grid_size)}}}function drawPing(ping,_grid_id){ping.shape="circle";ping.color="f44242";ping.size=cursor_size;ping.id=ping_counter++;ping.frame_counter=0;ping.opacity=0;local_stored_pings.push(ping);console.log(ping);window.setTimeout(function(){pingAnimation(ping,_grid_id)},ping_period)}function pingAnimation(ping,_grid_id){if(_grid_id!=grid_id)return;temporary_drawing_ctx.save();switch(true){case ping.frame_counter>=0&&ping.frame_counter<250:temporary_drawing_ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height);x=gridPoint2Pixel(ping.x)+grid_line_width;y=gridPoint2Pixel(ping.y)+grid_line_width;ping.opacity+=opacity_rate;ping.opacity=ping.opacity>=1?1:ping.opacity;temporary_drawing_ctx.beginPath();temporary_drawing_ctx.fillStyle="#"+ping.color;temporary_drawing_ctx.globalAlpha=ping.opacity;temporary_drawing_ctx.arc(x+grid_size/2*ping.size.width,y+grid_size/2*ping.size.height,ping.size.width*(grid_size/2)-grid_line_width,0,2*Math.PI);temporary_drawing_ctx.fill();break;case ping.frame_counter>=250&&ping.frame_counter<750:temporary_drawing_ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height);x=gridPoint2Pixel(ping.x)+grid_line_width;y=gridPoint2Pixel(ping.y)+grid_line_width;temporary_drawing_ctx.beginPath();temporary_drawing_ctx.fillStyle="#"+ping.color;temporary_drawing_ctx.globalAlpha=Math.abs(ping.opacity);temporary_drawing_ctx.arc(x+grid_size/2*ping.size.width,y+grid_size/2*ping.size.height,ping.size.width*(grid_size/2)-grid_line_width,0,2*Math.PI);temporary_drawing_ctx.fill();break;case ping.frame_counter>=750&&ping.frame_counter<1e3:temporary_drawing_ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height);x=gridPoint2Pixel(ping.x)+grid_line_width;y=gridPoint2Pixel(ping.y)+grid_line_width;ping.opacity-=opacity_rate;ping.opacity=ping.opacity<=0?0:ping.opacity;temporary_drawing_ctx.beginPath();temporary_drawing_ctx.fillStyle="#"+ping.color;temporary_drawing_ctx.globalAlpha=ping.opacity;temporary_drawing_ctx.arc(x+grid_size/2*ping.size.width,y+grid_size/2*ping.size.height,ping.size.width*(grid_size/2)-grid_line_width,0,2*Math.PI);temporary_drawing_ctx.fill();break}temporary_drawing_ctx.restore();ping.frame_counter+=ping_period;console.log(ping.opacity);if(ping.frame_counter<1e3){window.setTimeout(function(){window.requestAnimationFrame(function(){pingAnimation(ping,_grid_id)})},ping_period)}else{local_stored_pings.splice(local_stored_pings.findIndex(function(el){return el.id==ping.id}),1);console.log("Stop!");temporary_drawing_ctx.clearRect(0,0,grid_canvas.width,grid_canvas.height);return}}function canvasClicked(x,y){$("#dragging_element_icon").remove();selected_element=null;var temp=local_stored_grid_space.find(function(el){return gridPoint2Pixel(el.x)<x&&gridPoint2Pixel(el.x+JSON.parse(el.size.width))>x&&gridPoint2Pixel(el.y)<y&&gridPoint2Pixel(el.y+JSON.parse(el.size.height))>y});if(isUndefined(temp)){cursor_size={width:1,height:1};selected_grid_x=pixel2GridPoint(x-x%grid_size);selected_grid_y=pixel2GridPoint(y-y%grid_size)}else{cursor_size=temp.size;selected_grid_x=temp.x;selected_grid_y=temp.y;selected_element=temp}clear_prev_cursor_position();if(x_vertices.length>0&&y_vertices.length){temporary_drawing_ctx.clearRect(0,0,temporary_drawing_canvas.width,temporary_drawing_canvas.height);var temp_x=x_vertices.slice(0);var temp_y=y_vertices.slice(0);temp_x.push(selected_grid_x);temp_y.push(selected_grid_y);draw_temporary_item({type:"line",x:temp_x,y:temp_y,color:$("#element_color").val,size:3})}draw_cursor_at_position(selected_grid_x,selected_grid_y,cursor_size);updateSideMenuContent()}var grid_size=20;var grid_count_width=0;var grid_count_height=0;var grid_id=0;var cPosX=0,cPosY=0;var selected_grid_x=-1;var selected_grid_y=-1;var selected_element;var cursor_size=1;var local_stored_grid_space=[];var local_stored_annotations=[];var grid_spaces_list=[];var x_vertices=[];var y_vertices=[];var grid_canvas,ctx,underlay_canvas,ctx2,overlay_canvas,overlay_ctx,temporary_drawing_canvas,temporary_drawing_ctx;var mouse_down=false;var touch_start=false;var copied_element=null;var socket;var movementInterval=100;var ping_period=10;var opacity_rate=.04;var cursor_line_width=1;var ping_counter=0;var local_stored_pings=[];var grid_color="rgba(200,200,200,1)";var grid_highlight="rgba(0,153,0,1)";var grid_line_width=.5;var hoverTimer,movementTimer;function bindEventHandlers(){$("#grid_size_vertical").val(grid_count_height);$("#grid_size_horizontal").val(grid_count_width);$("#grid_size_vertical").change(function(){grid_count_height=$("#grid_size_vertical").val();socket.emit("resize_height",{grid_id:grid_id,height:grid_count_height})});$("#grid_size_horizontal").change(function(){grid_count_width=$("#grid_size_horizontal").val();socket.emit("resize_width",{grid_id:grid_id,width:grid_count_width})});$("#grid_name").change(function(){socket.emit("rename_grid",{grid_id:grid_id,grid_name:$("#grid_name").val()})});$("#place_element_button").click(function(){if($("#place_element_button").text()==="Add"||$("#place_element_button").text()==="Add Vertex"){switch($("#selected_shape").val()){case"square":case"circle":add_element_to_server($("#element_color").val(),selected_grid_x,selected_grid_y,$("#selected_shape").val(),$("#element_name").val(),{width:$("#element_size").val(),height:$("#element_size").val()},$("#element_category").val());break;case"rectangle":add_element_to_server($("#element_color").val(),selected_grid_x,selected_grid_y,$("#selected_shape").val(),$("#element_name").val(),{width:$("#element_width").val(),height:$("#element_height").val()},$("#element_category").val());break;case"line":x_vertices.push(selected_grid_x);y_vertices.push(selected_grid_y);if(x_vertices.length===1&&y_vertices.length===1)$("#start_new_line_button").toggle();break}}else{socket.emit("edit_element_on_server",{grid_id:grid_id,id:selected_element.id,name:$("#element_name").val(),shape:$("#selected_shape").val(),color:$("#element_color").val(),x:selected_element.x,y:selected_element.y,size:$("#element_size").val(),category:$("#element_category").val()})}});$("#b_rotate_left").click(function(){socket.emit("edit_element_on_server",{grid_id:grid_id,id:selected_element.id,name:selected_element.name,shape:selected_element.shape,color:selected_element.color,x:selected_element.x,y:selected_element.y,size:{width:selected_element.size.height,height:selected_element.size.width},category:selected_element.category})});$("#b_rotate_right").click(function(){socket.emit("edit_element_on_server",{grid_id:grid_id,id:selected_element.id,name:selected_element.name,shape:selected_element.shape,color:selected_element.color,x:selected_element.x,y:selected_element.y,size:{width:selected_element.size.height,height:selected_element.size.width},category:selected_element.category})});$("#reset_board_button").click(function(){if(confirm("This will delete EVERYTHING on the board.\nAre you sure you want to do this?")){socket.emit("reset_board",{grid_id:grid_id});$("#reset_board_button").prop("disabled",true);refresh_elements_list()}});$("#start_new_line_button").click(function(){temporary_drawing_ctx.clearRect(0,0,temporary_drawing_canvas.width,temporary_drawing_canvas.height);if(selected_grid_x!==x_vertices[x_vertices.length-1]||selected_grid_y!==y_vertices[y_vertices.length-1]){x_vertices.push(selected_grid_x);y_vertices.push(selected_grid_y)}if(x_vertices.length>1&&y_vertices.length>1)add_element_to_server($("#element_color").val(),x_vertices,y_vertices,$("#selected_shape").val(),null,$("#element_size").val(),$("#element_category").val());x_vertices=[];y_vertices=[];$("#start_new_line_button").toggle()});$("#move_inc_up").mousedown(function(){incremental_move_element("up");movementTimer=window.setInterval(function(){incremental_move_element("up")},movementInterval)}).mouseup(function(){window.clearInterval(movementTimer)}).on("touchstart",function(evt){incremental_move_element("up");movementTimer=window.setInterval(function(){incremental_move_element("up")},movementInterval)}).on("touchend",function(evt){window.clearInterval(movementTimer)});$("#move_inc_down").mousedown(function(){incremental_move_element("down");movementTimer=setInterval(function(){incremental_move_element("down")},movementInterval)}).mouseup(function(){clearInterval(movementTimer)}).on("touchstart",function(evt){incremental_move_element("down");movementTimer=window.setInterval(function(){incremental_move_element("down")},movementInterval)}).on("touchend",function(evt){window.clearInterval(movementTimer)});$("#move_inc_left").mousedown(function(){incremental_move_element("left");movementTimer=setInterval(function(){incremental_move_element("left")},movementInterval)}).mouseup(function(){clearInterval(movementTimer)}).on("touchstart",function(evt){incremental_move_element("left");movementTimer=window.setInterval(function(){incremental_move_element("left")},movementInterval)}).on("touchend",function(evt){window.clearInterval(movementTimer)});$("#move_inc_right").mousedown(function(){incremental_move_element("right");movementTimer=setInterval(function(){incremental_move_element("right")},movementInterval)}).mouseup(function(){clearInterval(movementTimer)}).on("touchstart",function(evt){incremental_move_element("right");movementTimer=window.setInterval(function(){incremental_move_element("right")},movementInterval)}).on("touchend",function(evt){window.clearInterval(movementTimer)});$("#selected_shape").change(function(el){switch($("#selected_shape").val()){case"line":$("#place_element_button").html("Add Vertex");break;case"square":case"circle":$("#place_element_button").html("Add");$("#start_new_line_button").hide();break}if(selected_grid_x==-1&&selected_grid_y==-1){return}for(var i=1;i<x_vertices.length;i++){clear_item("line",[x_vertices[i-1],x_vertices[i]],[y_vertices[i-1],y_vertices[i]],{},0)}x_vertices.length=[];y_vertices.length=[];clear_prev_cursor_position();draw_cursor_at_position(selected_grid_x,selected_grid_y)});$("#drawing_controls_button").click(function(){$("#drawing_controls").toggle();$("#movement_controls").hide();$("#settings_controls").hide();$("#editing_controls").hide()});$("#movement_controls_button").click(function(){$("#movement_controls").toggle();$("#drawing_controls").hide();$("#settings_controls").hide();$("#editing_controls").hide()});$("#settings_controls_button").click(function(){$("#settings_controls").toggle();$("#drawing_controls").hide();$("#movement_controls").hide();$("#editing_controls").hide()});$("#grid_down").click(function(){$("#grid_space_dropdown").toggle()});$("#drawing_controls_btn").click(function(){$("#drawing_controls").toggle()});$("#editing_controls_btn").click(function(){$("#editing_controls").toggle()});$("#movement_controls_btn").click(function(){$("#movement_controls").toggle()});$("#settings_controls_btn").click(function(){$("#settings_controls").toggle()});$("#element_list_btn").click(function(){$("#element_list_dropdown").toggle()});$("#editing_controls_done").click(function(){socket.emit("edit_element_on_server",{grid_id:grid_id,id:$("#edit_element_id").val(),name:$("#edit_name").val(),type:$("#edit_shape").val(),color:$("#edit_color").val(),size:$("#edit_size").val(),category:$("#edit_category").val()});removeEditMenu()});$("#randomize").click(function(){socket.emit("randomize",{grid_id:grid_id})});$(".element_filter").click(function(){refresh_elements_list()});$("#addition_tab").click(function(){socket.emit("create_grid_space",{})});$("#list_header_elements").click(function(){$("#list_header_elements").css("background","#345eb2");$("#list_header_elements").css("color","white");$("#list_header_annotations").css("background"," #dddddd");$("#list_header_annotations").css("color","black");$("#annotations_list_container").hide();$("#element_list_container").show()});$("#list_header_annotations").click(function(){$("#list_header_annotations").css("background","#345eb2");$("#list_header_annotations").css("color","white");$("#list_header_elements").css("background"," #dddddd");$("#list_header_elements").css("color","black");$("#element_list_container").hide();$("#annotations_list_container").show()});$("#annotations_display").change(function(){$(".grid_canvas_annotation").toggle()});$(document).on("click","#tab_row .grid-name",function(evt){$(".tab").removeClass("active");$(this).parent().addClass("active");grid_id=$(this).val();socket.emit("request_grid_space",{id:$(this).val()},function(msg){grid_count_height=msg.grid_space.height;resizeGridHeight(grid_count_height);grid_count_width=msg.grid_space.width;resizeGridWidth(grid_count_width);clearPlayerName();local_stored_grid_space=[];local_stored_annotations=[];local_stored_pings=[];$("#grid_name").val(msg.grid_space.name);if(msg.grid_space.elements.length!==0){local_stored_grid_space=msg.grid_space.elements;$("#reset_board_button").prop("disabled",false);drawElements()}if(msg.grid_space.annotations.length!==0){local_stored_annotations=msg.grid_space.annotations}refresh_elements_list();refresh_annotations_list();$("#options_add_or_edit_button").hide();$("#options_annotate_button").hide();$("#options_delete_button").hide();$("#options_copy_button").hide();$("#options_paste_button").hide();$("#options_movement_button").hide()})}).on("click","#context_editing_controls_done",function(evt){socket.emit("edit_element_on_server",{grid_id:grid_id,id:$("#context_edit_element_id").val(),name:$("#context_edit_name").val(),type:$("#context_edit_shape").val(),color:$("#context_edit_color").val(),size:$("#context_edit_size").val(),category:$("#context_edit_category").val()})}).on("click","#context_annotation_controls_done",function(evt){socket.emit("add_annotation_to_server",{grid_id:grid_id,title:"",content:$("#annotation_content").val(),x:selected_grid_x,y:selected_grid_y})}).on("mousedown","#dragging_element_icon",function(evt){mouse_down=true}).on("touchstart","#dragging_element_icon",function(evt){touch_start=true}).mousemove(function(evt){if(mouse_down){$("#dragging_element_icon").css("top",evt.clientY-grid_size/2);$("#dragging_element_icon").css("left",evt.clientX-grid_size/2);temporary_drawing_ctx.clearRect(0,0,temporary_drawing_canvas.width,temporary_drawing_canvas.height);draw_temporary_cursor_at_position(evt.clientX-evt.clientX%grid_size-$("#temporary_drawing_canvas").offset().left+grid_size-$("#grid_canvas_scrolling_container").scrollLeft()%grid_size,evt.clientY-evt.clientY%grid_size-$("#temporary_drawing_canvas").offset().top+grid_size-$("#grid_canvas_scrolling_container").scrollTop()%grid_size,cursor_size)}}).on("touchmove","#dragging_element_icon",function(evt){if(touch_start){$("#dragging_element_icon").css("top",evt.originalEvent.touches[0].clientY-grid_size/2);$("#dragging_element_icon").css("left",evt.originalEvent.touches[0].clientX-grid_size/2);temporary_drawing_ctx.clearRect(0,0,temporary_drawing_canvas.width,temporary_drawing_canvas.height);draw_temporary_cursor_at_position(evt.originalEvent.touches[0].clientX-evt.originalEvent.touches[0].clientX%grid_size-$("#temporary_drawing_canvas").offset().left+grid_size,evt.originalEvent.touches[0].clientY-evt.originalEvent.touches[0].clientY%grid_size-$("#temporary_drawing_canvas").offset().top+grid_size,cursor_size)}}).on("mouseup","#dragging_element_icon",function(evt){dragElement(evt.clientX,evt.clientY,evt.pageX,evt.pageY);mouse_down=false}).on("touchend","#dragging_element_icon",function(evt){dragElement(evt.originalEvent.changedTouches[0].clientX,evt.originalEvent.changedTouches[0].clientY,evt.originalEvent.changedTouches[0].pageX,evt.originalEvent.changedTouches[0].pageY);touch_start=false}).on("click","#tab_row .grid-space-delete",function(evt){if(confirm("Are you sure you want to delete this board? This action cannot be undone.")){socket.emit("delete_grid_space_from_server",{grid_id:$(this).val()})}});$("#grid_canvas").focus();$(document).keydown(function(e){switch(e.which){case 37:e.preventDefault();$("#move_inc_left").mousedown().mouseup();break;case 38:e.preventDefault();$("#move_inc_up").mousedown().mouseup();break;case 39:e.preventDefault();$("#move_inc_right").mousedown().mouseup();break;case 40:e.preventDefault();$("#move_inc_down").mousedown().mouseup();break}});$("#overlapping_container_tab").click(function(evt){$("#side_container_swap > *").hide();$("#options_container").show();$("#overlapping_side_container").show();$("#overlapping_back_button").hide();$(".drawing_canvas").css("padding-right",$("#overlapping_side_container").css("display")=="block"?"500px":"300px");$("#tab_row").css("padding-right",$("#overlapping_side_container").css("display")=="block"?"200px":"0px")});$("#overlapping_back_button").click(function(evt){$("#overlapping_back_button").hide();getContextMenu()})}function composeElementListRowElement(el){return'<div class="element_list_row" onclick="clicked_element_list('+el.id+')" id='+el.id+">"+'<div style="width: 25%; display: inline-block;">'+'<p style="font-size: smaller;">'+el.name+"<p>"+"</div>"+'<div style="width: 35%; display: inline-block;">'+'<p style="font-size: smaller;">'+el.category+"<p>"+"</div>"+'<button id="element_row_edit" onClick="editElementRow('+el.id+')">&#x270E;</button>'+'<button id="element_row_delete" onclick="delete_element_from_server('+el.id+')">&times</button>'+"</div>"}function composeAnnotationListRowElement(el){return'<div class="element_list_row" onclick="clicked_annotation_list('+el.id+')">'+"<p>"+el.content+"<p>"+'<button id="element_row_edit" onClick="editAnnotationRow('+el.id+')">&#x270E;</button>'+'<button id="element_row_delete" onclick="delete_annotation_from_server('+el.id+')">&times</button>'+"</div>"}function showLongHoldMenu(x,y,id){if(id!=-1)$("body").append('<span id="dragging_element_icon" class="glyphicon popup_items" style="position:absolute;top:'+(y-grid_size)+"px;left:"+(x-grid_size*2)+"px;width:"+grid_size+"px;height:"+grid_size+'px;font-size: 18px;">&#xe068;</span>');getContextMenu()}function getContextMenu(){$("#overlapping_back_button").hide();$("#side_container_swap > *").hide();$("#options_container").show();$("#overlapping_side_container").show();$(".drawing_canvas").css("padding-right",$("#overlapping_side_container").css("display")=="block"?"500px":"300px");$("#tab_row").css("padding-right",$("#overlapping_side_container").css("display")=="block"?"500px":"0")}function updateSideMenuContent(){$("#options_add_or_edit_button").show();if(selected_element===null){$("#options_add_or_edit_button").text("Add");$("#options_copy_button").hide();$("#options_paste_button").hide();$("#options_delete_button").hide();$("#options_movement_button").hide()}else{$("#options_add_or_edit_button").text("Edit");$("#options_copy_button").show();$("#options_paste_button").show();$("#options_delete_button").show();$("#options_movement_button").show()}if(copied_element===null){$("#options_paste_button").hide()}else{$("#options_paste_button").show()}$("#options_annotate_button").show()}function selectedMenuOption(option){switch(option){case"lists":$("#overlapping_back_button").show();$("#options_container").hide();$("#overlapping_container").show();break;case"grid_space":$("#overlapping_back_button").show();$("#options_container").hide();$("#grid_space_container").show();break;case"add_or_edit":$("#overlapping_back_button").show();$("#options_container").hide();$("#add_container").show();var isAdd=$("#options_add_or_edit_button").text()==="Add";$("#selected_shape").val(isAdd?"square":selected_element.shape);$("#element_color").val(isAdd?"000000":selected_element.color);$("#element_color_changer")[0].jscolor.fromString(isAdd?"#000000":"#"+selected_element.color);$("#element_size").val(isAdd?1:selected_element.size);$("#element_category").val(isAdd?"environment":selected_element.category);$("#element_name").val(isAdd?"object":selected_element.name);$("#place_element_button").text(isAdd?"Add":"Submit");break;case"movement":$("#overlapping_back_button").show();$("#options_container").hide();$("#movement_container").show();break;case"copy":copied_element=local_stored_grid_space.find(function(el){return el.x==selected_grid_x&&el.y==selected_grid_y});copied_element.grid_id=grid_id;break;case"paste":add_element_to_server(copied_element.color,selected_grid_x,selected_grid_y,copied_element.shape,copied_element.name,copied_element.size,copied_element.category);break;case"close":$("#overlapping_side_container").hide();$(".drawing_canvas").css("padding-right",$("#overlapping_side_container").css("display")=="block"?"500px":"300px");$("#tab_row").css("padding-right",$("#overlapping_side_container").css("display")=="block"?"200px":"0px");break;case"delete":socket.emit("delete_element_on_server",{grid_id:grid_id,element_id:selected_element.id});break;case"annotate":$("#overlapping_back_button").show();$("#options_container").hide();$("#annotations_container").show();break}}function showAnnotations(){local_stored_annotations.forEach(function(el){$("#grid_canvas_scrolling_container").append('<span class="grid_canvas_annotation" style="position: absolute; top: '+(gridPoint2Pixel(el.y)+$("#temporary_drawing_canvas").offset().top)+"px; left: "+(gridPoint2Pixel(el.x)+$("#temporary_drawing_canvas").offset().left)+'px; z-index: 2;">&#x2139;</span>')});if(!$("#annotations_display").attr("checked"))$(".grid_canvas_annotations").hide()}function hideAnnotations(){$("#grid_canvas_scrolling_container .grid_canvas_annotation").remove()}function showPlayerName(x,y,name){$("body").append('<div id="popup_name" class="popup_items" style="top:'+y+"px; left:"+x+'px"><p>'+name+"</p></div>")}function clearPlayerName(){$("#popup_name").remove()}function editElementRow(id){selected_element=local_stored_grid_space.find(function(el){return el.id==id});$("#overlapping_container").hide();$("#add_container").show();$("#selected_shape").val(selected_element.shape);$("#element_color").val(selected_element.color);$("#element_color_changer")[0].jscolor.fromString(selected_element.color);$("#element_size").val(selected_element.size);$("#element_category").val(selected_element.category);$("#element_name").val(selected_element.name);$("#vertices_list").empty();if(selected_element.shape==="line"){selected_element.x.forEach(function(_,ind){$("#vertices_list").append("<p>"+selected_element.x[ind]+","+selected_element.y[ind]+"</p>")})}$("#place_element_button").text("Submit")}function refresh_elements_list(){var filters=document.querySelectorAll(".element_filter:checked");var filter=[];for(var i=0;i<=filters.length-1;i++){filter[i]=filters[i].value}if(filters.length!==0){$("#element_list").empty();local_stored_grid_space.filter(function(el){return filter.indexOf(el.category)!=-1}).forEach(function(el){$("#element_list").append(composeElementListRowElement(el))})}else{$("#element_list").empty()}}function clicked_element_list(id){console.log("TODO: Implement clicking element list items.")}function clicked_annotation_list(id){var temp=local_stored_annotations.find(function(el){return el.id==id});clear_prev_cursor_position();draw_cursor_at_position(temp.x,temp.y,1)}function resizeGridWidth(width){grid_count_width=width;$("#grid_size_horizontal").val(grid_count_width);grid_canvas.width=grid_size*grid_count_width+2*grid_line_width;underlay_canvas.width=grid_size*grid_count_width+2*grid_line_width;overlay_canvas.width=grid_size*grid_count_width+2*grid_line_width;temporary_drawing_canvas.width=grid_size*grid_count_width+2*grid_line_width;drawScreen();drawTopRuler()}function resizeGridHeight(height){grid_count_height=height;$("#grid_size_vertical").val(grid_count_height);grid_canvas.height=grid_size*grid_count_height+2*grid_line_width;underlay_canvas.height=grid_size*grid_count_height+2*grid_line_width;overlay_canvas.height=grid_size*grid_count_height+2*grid_line_width;temporary_drawing_canvas.height=grid_size*grid_count_height+2*grid_line_width;drawScreen();drawLeftRuler()}"use strict";window.jscolor||(window.jscolor=function(){var e={register:function(){e.attachDOMReadyEvent(e.init),e.attachEvent(document,"mousedown",e.onDocumentMouseDown),e.attachEvent(document,"touchstart",e.onDocumentTouchStart),e.attachEvent(window,"resize",e.onWindowResize)},init:function(){e.jscolor.lookupClass&&e.jscolor.installByClassName(e.jscolor.lookupClass)},tryInstallOnElements:function(t,n){var r=new RegExp("(^|\\s)("+n+")(\\s*(\\{[^}]*\\})|\\s|$)","i");for(var i=0;i<t.length;i+=1){if(t[i].type!==undefined&&t[i].type.toLowerCase()=="color"&&e.isColorAttrSupported)continue;var s;if(!t[i].jscolor&&t[i].className&&(s=t[i].className.match(r))){var o=t[i],u=null,a=e.getDataAttr(o,"jscolor");a!==null?u=a:s[4]&&(u=s[4]);var f={};if(u)try{f=new Function("return ("+u+")")()}catch(l){e.warn("Error parsing jscolor options: "+l+":\n"+u)}o.jscolor=new e.jscolor(o,f)}}},isColorAttrSupported:function(){var e=document.createElement("input");if(e.setAttribute){e.setAttribute("type","color");if(e.type.toLowerCase()=="color")return!0}return!1}(),isCanvasSupported:function(){var e=document.createElement("canvas");return!!e.getContext&&!!e.getContext("2d")}(),fetchElement:function(e){return typeof e=="string"?document.getElementById(e):e},isElementType:function(e,t){return e.nodeName.toLowerCase()===t.toLowerCase()},getDataAttr:function(e,t){var n="data-"+t,r=e.getAttribute(n);return r!==null?r:null},attachEvent:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},detachEvent:function(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)},_attachedGroupEvents:{},attachGroupEvent:function(t,n,r,i){e._attachedGroupEvents.hasOwnProperty(t)||(e._attachedGroupEvents[t]=[]),e._attachedGroupEvents[t].push([n,r,i]),e.attachEvent(n,r,i)},detachGroupEvents:function(t){if(e._attachedGroupEvents.hasOwnProperty(t)){for(var n=0;n<e._attachedGroupEvents[t].length;n+=1){var r=e._attachedGroupEvents[t][n];e.detachEvent(r[0],r[1],r[2])}delete e._attachedGroupEvents[t]}},attachDOMReadyEvent:function(e){var t=!1,n=function(){t||(t=!0,e())};if(document.readyState==="complete"){setTimeout(n,1);return}if(document.addEventListener)document.addEventListener("DOMContentLoaded",n,!1),window.addEventListener("load",n,!1);else if(document.attachEvent){document.attachEvent("onreadystatechange",function(){document.readyState==="complete"&&(document.detachEvent("onreadystatechange",arguments.callee),n())}),window.attachEvent("onload",n);if(document.documentElement.doScroll&&window==window.top){var r=function(){if(!document.body)return;try{document.documentElement.doScroll("left"),n()}catch(e){setTimeout(r,1)}};r()}}},warn:function(e){window.console&&window.console.warn&&window.console.warn(e)},preventDefault:function(e){e.preventDefault&&e.preventDefault(),e.returnValue=!1},captureTarget:function(t){t.setCapture&&(e._capturedTarget=t,e._capturedTarget.setCapture())},releaseTarget:function(){e._capturedTarget&&(e._capturedTarget.releaseCapture(),e._capturedTarget=null)},fireEvent:function(e,t){if(!e)return;if(document.createEvent){var n=document.createEvent("HTMLEvents");n.initEvent(t,!0,!0),e.dispatchEvent(n)}else if(document.createEventObject){var n=document.createEventObject();e.fireEvent("on"+t,n)}else e["on"+t]&&e["on"+t]()},classNameToList:function(e){return e.replace(/^\s+|\s+$/g,"").split(/\s+/)},hasClass:function(e,t){return t?-1!=(" "+e.className.replace(/\s+/g," ")+" ").indexOf(" "+t+" "):!1},setClass:function(t,n){var r=e.classNameToList(n);for(var i=0;i<r.length;i+=1)e.hasClass(t,r[i])||(t.className+=(t.className?" ":"")+r[i])},unsetClass:function(t,n){var r=e.classNameToList(n);for(var i=0;i<r.length;i+=1){var s=new RegExp("^\\s*"+r[i]+"\\s*|"+"\\s*"+r[i]+"\\s*$|"+"\\s+"+r[i]+"(\\s+)","g");t.className=t.className.replace(s,"$1")}},getStyle:function(e){return window.getComputedStyle?window.getComputedStyle(e):e.currentStyle},setStyle:function(){var e=document.createElement("div"),t=function(t){for(var n=0;n<t.length;n+=1)if(t[n]in e.style)return t[n]},n={borderRadius:t(["borderRadius","MozBorderRadius","webkitBorderRadius"]),boxShadow:t(["boxShadow","MozBoxShadow","webkitBoxShadow"])};return function(e,t,r){switch(t.toLowerCase()){case"opacity":var i=Math.round(parseFloat(r)*100);e.style.opacity=r,e.style.filter="alpha(opacity="+i+")";break;default:e.style[n[t]]=r}}}(),setBorderRadius:function(t,n){e.setStyle(t,"borderRadius",n||"0")},setBoxShadow:function(t,n){e.setStyle(t,"boxShadow",n||"none")},getElementPos:function(t,n){var r=0,i=0,s=t.getBoundingClientRect();r=s.left,i=s.top;if(!n){var o=e.getViewPos();r+=o[0],i+=o[1]}return[r,i]},getElementSize:function(e){return[e.offsetWidth,e.offsetHeight]},getAbsPointerPos:function(e){e||(e=window.event);var t=0,n=0;return typeof e.changedTouches!="undefined"&&e.changedTouches.length?(t=e.changedTouches[0].clientX,n=e.changedTouches[0].clientY):typeof e.clientX=="number"&&(t=e.clientX,n=e.clientY),{x:t,y:n}},getRelPointerPos:function(e){e||(e=window.event);var t=e.target||e.srcElement,n=t.getBoundingClientRect(),r=0,i=0,s=0,o=0;return typeof e.changedTouches!="undefined"&&e.changedTouches.length?(s=e.changedTouches[0].clientX,o=e.changedTouches[0].clientY):typeof e.clientX=="number"&&(s=e.clientX,o=e.clientY),r=s-n.left,i=o-n.top,{x:r,y:i}},getViewPos:function(){var e=document.documentElement;return[(window.pageXOffset||e.scrollLeft)-(e.clientLeft||0),(window.pageYOffset||e.scrollTop)-(e.clientTop||0)]},getViewSize:function(){var e=document.documentElement;return[window.innerWidth||e.clientWidth,window.innerHeight||e.clientHeight]},redrawPosition:function(){if(e.picker&&e.picker.owner){var t=e.picker.owner,n,r;t.fixed?(n=e.getElementPos(t.targetElement,!0),r=[0,0]):(n=e.getElementPos(t.targetElement),r=e.getViewPos());var i=e.getElementSize(t.targetElement),s=e.getViewSize(),o=e.getPickerOuterDims(t),u,a,f;switch(t.position.toLowerCase()){case"left":u=1,a=0,f=-1;break;case"right":u=1,a=0,f=1;break;case"top":u=0,a=1,f=-1;break;default:u=0,a=1,f=1}var l=(i[a]+o[a])/2;if(!t.smartPosition)var c=[n[u],n[a]+i[a]-l+l*f];else var c=[-r[u]+n[u]+o[u]>s[u]?-r[u]+n[u]+i[u]/2>s[u]/2&&n[u]+i[u]-o[u]>=0?n[u]+i[u]-o[u]:n[u]:n[u],-r[a]+n[a]+i[a]+o[a]-l+l*f>s[a]?-r[a]+n[a]+i[a]/2>s[a]/2&&n[a]+i[a]-l-l*f>=0?n[a]+i[a]-l-l*f:n[a]+i[a]-l+l*f:n[a]+i[a]-l+l*f>=0?n[a]+i[a]-l+l*f:n[a]+i[a]-l-l*f];var h=c[u],p=c[a],d=t.fixed?"fixed":"absolute",v=(c[0]+o[0]>n[0]||c[0]<n[0]+i[0])&&c[1]+o[1]<n[1]+i[1];e._drawPosition(t,h,p,d,v)}},_drawPosition:function(t,n,r,i,s){var o=s?0:t.shadowBlur;e.picker.wrap.style.position=i,e.picker.wrap.style.left=n+"px",e.picker.wrap.style.top=r+"px",e.setBoxShadow(e.picker.boxS,t.shadow?new e.BoxShadow(0,o,t.shadowBlur,0,t.shadowColor):null)},getPickerDims:function(t){var n=!!e.getSliderComponent(t),r=[2*t.insetWidth+2*t.padding+t.width+(n?2*t.insetWidth+e.getPadToSliderPadding(t)+t.sliderSize:0),2*t.insetWidth+2*t.padding+t.height+(t.closable?2*t.insetWidth+t.padding+t.buttonHeight:0)];return r},getPickerOuterDims:function(t){var n=e.getPickerDims(t);return[n[0]+2*t.borderWidth,n[1]+2*t.borderWidth]},getPadToSliderPadding:function(e){return Math.max(e.padding,1.5*(2*e.pointerBorderWidth+e.pointerThickness))},getPadYComponent:function(e){switch(e.mode.charAt(1).toLowerCase()){case"v":return"v"}return"s"},getSliderComponent:function(e){if(e.mode.length>2)switch(e.mode.charAt(2).toLowerCase()){case"s":return"s";case"v":return"v"}return null},onDocumentMouseDown:function(t){t||(t=window.event);var n=t.target||t.srcElement;n._jscLinkedInstance?n._jscLinkedInstance.showOnClick&&n._jscLinkedInstance.show():n._jscControlName?e.onControlPointerStart(t,n,n._jscControlName,"mouse"):e.picker&&e.picker.owner&&e.picker.owner.hide()},onDocumentTouchStart:function(t){t||(t=window.event);var n=t.target||t.srcElement;n._jscLinkedInstance?n._jscLinkedInstance.showOnClick&&n._jscLinkedInstance.show():n._jscControlName?e.onControlPointerStart(t,n,n._jscControlName,"touch"):e.picker&&e.picker.owner&&e.picker.owner.hide()},onWindowResize:function(t){e.redrawPosition()},onParentScroll:function(t){e.picker&&e.picker.owner&&e.picker.owner.hide()},_pointerMoveEvent:{mouse:"mousemove",touch:"touchmove"},_pointerEndEvent:{mouse:"mouseup",touch:"touchend"},_pointerOrigin:null,_capturedTarget:null,onControlPointerStart:function(t,n,r,i){var s=n._jscInstance;e.preventDefault(t),e.captureTarget(n);var o=function(s,o){e.attachGroupEvent("drag",s,e._pointerMoveEvent[i],e.onDocumentPointerMove(t,n,r,i,o)),e.attachGroupEvent("drag",s,e._pointerEndEvent[i],e.onDocumentPointerEnd(t,n,r,i))};o(document,[0,0]);if(window.parent&&window.frameElement){var u=window.frameElement.getBoundingClientRect(),a=[-u.left,-u.top];o(window.parent.window.document,a)}var f=e.getAbsPointerPos(t),l=e.getRelPointerPos(t);e._pointerOrigin={x:f.x-l.x,y:f.y-l.y};switch(r){case"pad":switch(e.getSliderComponent(s)){case"s":s.hsv[1]===0&&s.fromHSV(null,100,null);break;case"v":s.hsv[2]===0&&s.fromHSV(null,null,100)}e.setPad(s,t,0,0);break;case"sld":e.setSld(s,t,0)}e.dispatchFineChange(s)},onDocumentPointerMove:function(t,n,r,i,s){return function(t){var i=n._jscInstance;switch(r){case"pad":t||(t=window.event),e.setPad(i,t,s[0],s[1]),e.dispatchFineChange(i);break;case"sld":t||(t=window.event),e.setSld(i,t,s[1]),e.dispatchFineChange(i)}}},onDocumentPointerEnd:function(t,n,r,i){return function(t){var r=n._jscInstance;e.detachGroupEvents("drag"),e.releaseTarget(),e.dispatchChange(r)}},dispatchChange:function(t){t.valueElement&&e.isElementType(t.valueElement,"input")&&e.fireEvent(t.valueElement,"change")},dispatchFineChange:function(e){if(e.onFineChange){var t;typeof e.onFineChange=="string"?t=new Function(e.onFineChange):t=e.onFineChange,t.call(e)}},setPad:function(t,n,r,i){var s=e.getAbsPointerPos(n),o=r+s.x-e._pointerOrigin.x-t.padding-t.insetWidth,u=i+s.y-e._pointerOrigin.y-t.padding-t.insetWidth,a=o*(360/(t.width-1)),f=100-u*(100/(t.height-1));switch(e.getPadYComponent(t)){case"s":t.fromHSV(a,f,null,e.leaveSld);break;case"v":t.fromHSV(a,null,f,e.leaveSld)}},setSld:function(t,n,r){var i=e.getAbsPointerPos(n),s=r+i.y-e._pointerOrigin.y-t.padding-t.insetWidth,o=100-s*(100/(t.height-1));switch(e.getSliderComponent(t)){case"s":t.fromHSV(null,o,null,e.leavePad);break;case"v":t.fromHSV(null,null,o,e.leavePad)}},_vmlNS:"jsc_vml_",_vmlCSS:"jsc_vml_css_",_vmlReady:!1,initVML:function(){if(!e._vmlReady){var t=document;t.namespaces[e._vmlNS]||t.namespaces.add(e._vmlNS,"urn:schemas-microsoft-com:vml");if(!t.styleSheets[e._vmlCSS]){var n=["shape","shapetype","group","background","path","formulas","handles","fill","stroke","shadow","textbox","textpath","imagedata","line","polyline","curve","rect","roundrect","oval","arc","image"],r=t.createStyleSheet();r.owningElement.id=e._vmlCSS;for(var i=0;i<n.length;i+=1)r.addRule(e._vmlNS+"\\:"+n[i],"behavior:url(#default#VML);")}e._vmlReady=!0}},createPalette:function(){var t={elm:null,draw:null};if(e.isCanvasSupported){var n=document.createElement("canvas"),r=n.getContext("2d"),i=function(e,t,i){n.width=e,n.height=t,r.clearRect(0,0,n.width,n.height);var s=r.createLinearGradient(0,0,n.width,0);s.addColorStop(0,"#F00"),s.addColorStop(1/6,"#FF0"),s.addColorStop(2/6,"#0F0"),s.addColorStop(.5,"#0FF"),s.addColorStop(4/6,"#00F"),s.addColorStop(5/6,"#F0F"),s.addColorStop(1,"#F00"),r.fillStyle=s,r.fillRect(0,0,n.width,n.height);var o=r.createLinearGradient(0,0,0,n.height);switch(i.toLowerCase()){case"s":o.addColorStop(0,"rgba(255,255,255,0)"),o.addColorStop(1,"rgba(255,255,255,1)");break;case"v":o.addColorStop(0,"rgba(0,0,0,0)"),o.addColorStop(1,"rgba(0,0,0,1)")}r.fillStyle=o,r.fillRect(0,0,n.width,n.height)};t.elm=n,t.draw=i}else{e.initVML();var s=document.createElement("div");s.style.position="relative",s.style.overflow="hidden";var o=document.createElement(e._vmlNS+":fill");o.type="gradient",o.method="linear",o.angle="90",o.colors="16.67% #F0F, 33.33% #00F, 50% #0FF, 66.67% #0F0, 83.33% #FF0";var u=document.createElement(e._vmlNS+":rect");u.style.position="absolute",u.style.left="-1px",u.style.top="-1px",u.stroked=!1,u.appendChild(o),s.appendChild(u);var a=document.createElement(e._vmlNS+":fill");a.type="gradient",a.method="linear",a.angle="180",a.opacity="0";var f=document.createElement(e._vmlNS+":rect");f.style.position="absolute",f.style.left="-1px",f.style.top="-1px",f.stroked=!1,f.appendChild(a),s.appendChild(f);var i=function(e,t,n){s.style.width=e+"px",s.style.height=t+"px",u.style.width=f.style.width=e+1+"px",u.style.height=f.style.height=t+1+"px",o.color="#F00",o.color2="#F00";switch(n.toLowerCase()){case"s":a.color=a.color2="#FFF";break;case"v":a.color=a.color2="#000"}};t.elm=s,t.draw=i}return t},createSliderGradient:function(){var t={elm:null,draw:null};if(e.isCanvasSupported){var n=document.createElement("canvas"),r=n.getContext("2d"),i=function(e,t,i,s){n.width=e,n.height=t,r.clearRect(0,0,n.width,n.height);var o=r.createLinearGradient(0,0,0,n.height);o.addColorStop(0,i),o.addColorStop(1,s),r.fillStyle=o,r.fillRect(0,0,n.width,n.height)};t.elm=n,t.draw=i}else{e.initVML();var s=document.createElement("div");s.style.position="relative",s.style.overflow="hidden";var o=document.createElement(e._vmlNS+":fill");o.type="gradient",o.method="linear",o.angle="180";var u=document.createElement(e._vmlNS+":rect");u.style.position="absolute",u.style.left="-1px",u.style.top="-1px",u.stroked=!1,u.appendChild(o),s.appendChild(u);var i=function(e,t,n,r){s.style.width=e+"px",s.style.height=t+"px",u.style.width=e+1+"px",u.style.height=t+1+"px",o.color=n,o.color2=r};t.elm=s,t.draw=i}return t},leaveValue:1,leaveStyle:2,leavePad:4,leaveSld:8,BoxShadow:function(){var e=function(e,t,n,r,i,s){this.hShadow=e,this.vShadow=t,this.blur=n,this.spread=r,this.color=i,this.inset=!!s};return e.prototype.toString=function(){var e=[Math.round(this.hShadow)+"px",Math.round(this.vShadow)+"px",Math.round(this.blur)+"px",Math.round(this.spread)+"px",this.color];return this.inset&&e.push("inset"),e.join(" ")},e}(),jscolor:function(t,n){function i(e,t,n){e/=255,t/=255,n/=255;var r=Math.min(Math.min(e,t),n),i=Math.max(Math.max(e,t),n),s=i-r;if(s===0)return[null,0,100*i];var o=e===r?3+(n-t)/s:t===r?5+(e-n)/s:1+(t-e)/s;return[60*(o===6?0:o),100*(s/i),100*i]}function s(e,t,n){var r=255*(n/100);if(e===null)return[r,r,r];e/=60,t/=100;var i=Math.floor(e),s=i%2?e-i:1-(e-i),o=r*(1-t),u=r*(1-t*s);switch(i){case 6:case 0:return[r,u,o];case 1:return[u,r,o];case 2:return[o,r,u];case 3:return[o,u,r];case 4:return[u,o,r];case 5:return[r,o,u]}}function o(){e.unsetClass(d.targetElement,d.activeClass),e.picker.wrap.parentNode.removeChild(e.picker.wrap),delete e.picker.owner}function u(){function l(){var e=d.insetColor.split(/\s+/),n=e.length<2?e[0]:e[1]+" "+e[0]+" "+e[0]+" "+e[1];t.btn.style.borderColor=n}d._processParentElementsInDOM(),e.picker||(e.picker={owner:null,wrap:document.createElement("div"),box:document.createElement("div"),boxS:document.createElement("div"),boxB:document.createElement("div"),pad:document.createElement("div"),padB:document.createElement("div"),padM:document.createElement("div"),padPal:e.createPalette(),cross:document.createElement("div"),crossBY:document.createElement("div"),crossBX:document.createElement("div"),crossLY:document.createElement("div"),crossLX:document.createElement("div"),sld:document.createElement("div"),sldB:document.createElement("div"),sldM:document.createElement("div"),sldGrad:e.createSliderGradient(),sldPtrS:document.createElement("div"),sldPtrIB:document.createElement("div"),sldPtrMB:document.createElement("div"),sldPtrOB:document.createElement("div"),btn:document.createElement("div"),btnT:document.createElement("span")},e.picker.pad.appendChild(e.picker.padPal.elm),e.picker.padB.appendChild(e.picker.pad),e.picker.cross.appendChild(e.picker.crossBY),e.picker.cross.appendChild(e.picker.crossBX),e.picker.cross.appendChild(e.picker.crossLY),e.picker.cross.appendChild(e.picker.crossLX),e.picker.padB.appendChild(e.picker.cross),e.picker.box.appendChild(e.picker.padB),e.picker.box.appendChild(e.picker.padM),e.picker.sld.appendChild(e.picker.sldGrad.elm),e.picker.sldB.appendChild(e.picker.sld),e.picker.sldB.appendChild(e.picker.sldPtrOB),e.picker.sldPtrOB.appendChild(e.picker.sldPtrMB),e.picker.sldPtrMB.appendChild(e.picker.sldPtrIB),e.picker.sldPtrIB.appendChild(e.picker.sldPtrS),e.picker.box.appendChild(e.picker.sldB),e.picker.box.appendChild(e.picker.sldM),e.picker.btn.appendChild(e.picker.btnT),e.picker.box.appendChild(e.picker.btn),e.picker.boxB.appendChild(e.picker.box),e.picker.wrap.appendChild(e.picker.boxS),e.picker.wrap.appendChild(e.picker.boxB));var t=e.picker,n=!!e.getSliderComponent(d),r=e.getPickerDims(d),i=2*d.pointerBorderWidth+d.pointerThickness+2*d.crossSize,s=e.getPadToSliderPadding(d),o=Math.min(d.borderRadius,Math.round(d.padding*Math.PI)),u="crosshair";t.wrap.style.clear="both",t.wrap.style.width=r[0]+2*d.borderWidth+"px",t.wrap.style.height=r[1]+2*d.borderWidth+"px",t.wrap.style.zIndex=d.zIndex,t.box.style.width=r[0]+"px",t.box.style.height=r[1]+"px",t.boxS.style.position="absolute",t.boxS.style.left="0",t.boxS.style.top="0",t.boxS.style.width="100%",t.boxS.style.height="100%",e.setBorderRadius(t.boxS,o+"px"),t.boxB.style.position="relative",t.boxB.style.border=d.borderWidth+"px solid",t.boxB.style.borderColor=d.borderColor,t.boxB.style.background=d.backgroundColor,e.setBorderRadius(t.boxB,o+"px"),t.padM.style.background=t.sldM.style.background="#FFF",e.setStyle(t.padM,"opacity","0"),e.setStyle(t.sldM,"opacity","0"),t.pad.style.position="relative",t.pad.style.width=d.width+"px",t.pad.style.height=d.height+"px",t.padPal.draw(d.width,d.height,e.getPadYComponent(d)),t.padB.style.position="absolute",t.padB.style.left=d.padding+"px",t.padB.style.top=d.padding+"px",t.padB.style.border=d.insetWidth+"px solid",t.padB.style.borderColor=d.insetColor,t.padM._jscInstance=d,t.padM._jscControlName="pad",t.padM.style.position="absolute",t.padM.style.left="0",t.padM.style.top="0",t.padM.style.width=d.padding+2*d.insetWidth+d.width+s/2+"px",t.padM.style.height=r[1]+"px",t.padM.style.cursor=u,t.cross.style.position="absolute",t.cross.style.left=t.cross.style.top="0",t.cross.style.width=t.cross.style.height=i+"px",t.crossBY.style.position=t.crossBX.style.position="absolute",t.crossBY.style.background=t.crossBX.style.background=d.pointerBorderColor,t.crossBY.style.width=t.crossBX.style.height=2*d.pointerBorderWidth+d.pointerThickness+"px",t.crossBY.style.height=t.crossBX.style.width=i+"px",t.crossBY.style.left=t.crossBX.style.top=Math.floor(i/2)-Math.floor(d.pointerThickness/2)-d.pointerBorderWidth+"px",t.crossBY.style.top=t.crossBX.style.left="0",t.crossLY.style.position=t.crossLX.style.position="absolute",t.crossLY.style.background=t.crossLX.style.background=d.pointerColor,t.crossLY.style.height=t.crossLX.style.width=i-2*d.pointerBorderWidth+"px",t.crossLY.style.width=t.crossLX.style.height=d.pointerThickness+"px",t.crossLY.style.left=t.crossLX.style.top=Math.floor(i/2)-Math.floor(d.pointerThickness/2)+"px",t.crossLY.style.top=t.crossLX.style.left=d.pointerBorderWidth+"px",t.sld.style.overflow="hidden",t.sld.style.width=d.sliderSize+"px",t.sld.style.height=d.height+"px",t.sldGrad.draw(d.sliderSize,d.height,"#000","#000"),t.sldB.style.display=n?"block":"none",t.sldB.style.position="absolute",t.sldB.style.right=d.padding+"px",t.sldB.style.top=d.padding+"px",t.sldB.style.border=d.insetWidth+"px solid",t.sldB.style.borderColor=d.insetColor,t.sldM._jscInstance=d,t.sldM._jscControlName="sld",t.sldM.style.display=n?"block":"none",t.sldM.style.position="absolute",t.sldM.style.right="0",t.sldM.style.top="0",t.sldM.style.width=d.sliderSize+s/2+d.padding+2*d.insetWidth+"px",t.sldM.style.height=r[1]+"px",t.sldM.style.cursor="default",t.sldPtrIB.style.border=t.sldPtrOB.style.border=d.pointerBorderWidth+"px solid "+d.pointerBorderColor,t.sldPtrOB.style.position="absolute",t.sldPtrOB.style.left=-(2*d.pointerBorderWidth+d.pointerThickness)+"px",t.sldPtrOB.style.top="0",t.sldPtrMB.style.border=d.pointerThickness+"px solid "+d.pointerColor,t.sldPtrS.style.width=d.sliderSize+"px",t.sldPtrS.style.height=m+"px",t.btn.style.display=d.closable?"block":"none",t.btn.style.position="absolute",t.btn.style.left=d.padding+"px",t.btn.style.bottom=d.padding+"px",t.btn.style.padding="0 15px",t.btn.style.height=d.buttonHeight+"px",t.btn.style.border=d.insetWidth+"px solid",l(),t.btn.style.color=d.buttonColor,t.btn.style.font="12px sans-serif",t.btn.style.textAlign="center";try{t.btn.style.cursor="pointer"}catch(c){t.btn.style.cursor="hand"}t.btn.onmousedown=function(){d.hide()},t.btnT.style.lineHeight=d.buttonHeight+"px",t.btnT.innerHTML="",t.btnT.appendChild(document.createTextNode(d.closeText)),a(),f(),e.picker.owner&&e.picker.owner!==d&&e.unsetClass(e.picker.owner.targetElement,d.activeClass),e.picker.owner=d,e.isElementType(v,"body")?e.redrawPosition():e._drawPosition(d,0,0,"relative",!1),t.wrap.parentNode!=v&&v.appendChild(t.wrap),e.setClass(d.targetElement,d.activeClass)}function a(){switch(e.getPadYComponent(d)){case"s":var t=1;break;case"v":var t=2}var n=Math.round(d.hsv[0]/360*(d.width-1)),r=Math.round((1-d.hsv[t]/100)*(d.height-1)),i=2*d.pointerBorderWidth+d.pointerThickness+2*d.crossSize,o=-Math.floor(i/2);e.picker.cross.style.left=n+o+"px",e.picker.cross.style.top=r+o+"px";switch(e.getSliderComponent(d)){case"s":var u=s(d.hsv[0],100,d.hsv[2]),a=s(d.hsv[0],0,d.hsv[2]),f="rgb("+Math.round(u[0])+","+Math.round(u[1])+","+Math.round(u[2])+")",l="rgb("+Math.round(a[0])+","+Math.round(a[1])+","+Math.round(a[2])+")";e.picker.sldGrad.draw(d.sliderSize,d.height,f,l);break;case"v":var c=s(d.hsv[0],d.hsv[1],100),f="rgb("+Math.round(c[0])+","+Math.round(c[1])+","+Math.round(c[2])+")",l="#000";e.picker.sldGrad.draw(d.sliderSize,d.height,f,l)}}function f(){var t=e.getSliderComponent(d);if(t){switch(t){case"s":var n=1;break;case"v":var n=2}var r=Math.round((1-d.hsv[n]/100)*(d.height-1));e.picker.sldPtrOB.style.top=r-(2*d.pointerBorderWidth+d.pointerThickness)-Math.floor(m/2)+"px"}}function l(){return e.picker&&e.picker.owner===d}function c(){d.importColor()}this.value=null,this.valueElement=t,this.styleElement=t,this.required=!0,this.refine=!0,this.hash=!1,this.uppercase=!0,this.onFineChange=null,this.activeClass="jscolor-active",this.minS=0,this.maxS=100,this.minV=0,this.maxV=100,this.hsv=[0,0,100],this.rgb=[255,255,255],this.width=181,this.height=101,this.showOnClick=!0,this.mode="HSV",this.position="bottom",this.smartPosition=!0,this.sliderSize=16,this.crossSize=8,this.closable=!1,this.closeText="Close",this.buttonColor="#000000",this.buttonHeight=18,this.padding=12,this.backgroundColor="#FFFFFF",this.borderWidth=1,this.borderColor="#BBBBBB",this.borderRadius=8,this.insetWidth=1,this.insetColor="#BBBBBB",this.shadow=!0,this.shadowBlur=15,this.shadowColor="rgba(0,0,0,0.2)",this.pointerColor="#4C4C4C",this.pointerBorderColor="#FFFFFF",this.pointerBorderWidth=1,this.pointerThickness=2,this.zIndex=1e3,this.container=null;for(var r in n)n.hasOwnProperty(r)&&(this[r]=n[r]);this.hide=function(){l()&&o()},this.show=function(){u()},this.redraw=function(){l()&&u()},this.importColor=function(){this.valueElement?e.isElementType(this.valueElement,"input")?this.refine?!this.required&&/^\s*$/.test(this.valueElement.value)?(this.valueElement.value="",this.styleElement&&(this.styleElement.style.backgroundImage=this.styleElement._jscOrigStyle.backgroundImage,this.styleElement.style.backgroundColor=this.styleElement._jscOrigStyle.backgroundColor,this.styleElement.style.color=this.styleElement._jscOrigStyle.color),this.exportColor(e.leaveValue|e.leaveStyle)):this.fromString(this.valueElement.value)||this.exportColor():this.fromString(this.valueElement.value,e.leaveValue)||(this.styleElement&&(this.styleElement.style.backgroundImage=this.styleElement._jscOrigStyle.backgroundImage,this.styleElement.style.backgroundColor=this.styleElement._jscOrigStyle.backgroundColor,this.styleElement.style.color=this.styleElement._jscOrigStyle.color),this.exportColor(e.leaveValue|e.leaveStyle)):this.exportColor():this.exportColor()},this.exportColor=function(t){if(!(t&e.leaveValue)&&this.valueElement){var n=this.toString();this.uppercase&&(n=n.toUpperCase()),this.hash&&(n="#"+n),e.isElementType(this.valueElement,"input")?this.valueElement.value=n:this.valueElement.innerHTML=n}t&e.leaveStyle||this.styleElement&&(this.styleElement.style.backgroundImage="none",this.styleElement.style.backgroundColor="#"+this.toString(),this.styleElement.style.color=this.isLight()?"#000":"#FFF"),!(t&e.leavePad)&&l()&&a(),!(t&e.leaveSld)&&l()&&f()},this.fromHSV=function(e,t,n,r){if(e!==null){if(isNaN(e))return!1;e=Math.max(0,Math.min(360,e))}if(t!==null){if(isNaN(t))return!1;t=Math.max(0,Math.min(100,this.maxS,t),this.minS)}if(n!==null){if(isNaN(n))return!1;n=Math.max(0,Math.min(100,this.maxV,n),this.minV)}this.rgb=s(e===null?this.hsv[0]:this.hsv[0]=e,t===null?this.hsv[1]:this.hsv[1]=t,n===null?this.hsv[2]:this.hsv[2]=n),this.exportColor(r)},this.fromRGB=function(e,t,n,r){if(e!==null){if(isNaN(e))return!1;e=Math.max(0,Math.min(255,e))}if(t!==null){if(isNaN(t))return!1;t=Math.max(0,Math.min(255,t))}if(n!==null){if(isNaN(n))return!1;n=Math.max(0,Math.min(255,n))}var o=i(e===null?this.rgb[0]:e,t===null?this.rgb[1]:t,n===null?this.rgb[2]:n);o[0]!==null&&(this.hsv[0]=Math.max(0,Math.min(360,o[0]))),o[2]!==0&&(this.hsv[1]=o[1]===null?null:Math.max(0,this.minS,Math.min(100,this.maxS,o[1]))),this.hsv[2]=o[2]===null?null:Math.max(0,this.minV,Math.min(100,this.maxV,o[2]));var u=s(this.hsv[0],this.hsv[1],this.hsv[2]);this.rgb[0]=u[0],this.rgb[1]=u[1],this.rgb[2]=u[2],this.exportColor(r)},this.fromString=function(e,t){var n;if(n=e.match(/^\W*([0-9A-F]{3}([0-9A-F]{3})?)\W*$/i))return n[1].length===6?this.fromRGB(parseInt(n[1].substr(0,2),16),parseInt(n[1].substr(2,2),16),parseInt(n[1].substr(4,2),16),t):this.fromRGB(parseInt(n[1].charAt(0)+n[1].charAt(0),16),parseInt(n[1].charAt(1)+n[1].charAt(1),16),parseInt(n[1].charAt(2)+n[1].charAt(2),16),t),!0;if(n=e.match(/^\W*rgba?\(([^)]*)\)\W*$/i)){var r=n[1].split(","),i=/^\s*(\d*)(\.\d+)?\s*$/,s,o,u;if(r.length>=3&&(s=r[0].match(i))&&(o=r[1].match(i))&&(u=r[2].match(i))){var a=parseFloat((s[1]||"0")+(s[2]||"")),f=parseFloat((o[1]||"0")+(o[2]||"")),l=parseFloat((u[1]||"0")+(u[2]||""));return this.fromRGB(a,f,l,t),!0}}return!1},this.toString=function(){return(256|Math.round(this.rgb[0])).toString(16).substr(1)+(256|Math.round(this.rgb[1])).toString(16).substr(1)+(256|Math.round(this.rgb[2])).toString(16).substr(1)},this.toHEXString=function(){return"#"+this.toString().toUpperCase()},this.toRGBString=function(){return"rgb("+Math.round(this.rgb[0])+","+Math.round(this.rgb[1])+","+Math.round(this.rgb[2])+")"},this.isLight=function(){return.213*this.rgb[0]+.715*this.rgb[1]+.072*this.rgb[2]>127.5},this._processParentElementsInDOM=function(){if(this._linkedElementsProcessed)return;this._linkedElementsProcessed=!0;var t=this.targetElement;do{var n=e.getStyle(t);n&&n.position.toLowerCase()==="fixed"&&(this.fixed=!0),t!==this.targetElement&&(t._jscEventsAttached||(e.attachEvent(t,"scroll",e.onParentScroll),t._jscEventsAttached=!0))}while((t=t.parentNode)&&!e.isElementType(t,"body"))};if(typeof t=="string"){var h=t,p=document.getElementById(h);p?this.targetElement=p:e.warn("Could not find target element with ID '"+h+"'")}else t?this.targetElement=t:e.warn("Invalid target element: '"+t+"'");if(this.targetElement._jscLinkedInstance){e.warn("Cannot link jscolor twice to the same element. Skipping.");return}this.targetElement._jscLinkedInstance=this,this.valueElement=e.fetchElement(this.valueElement),this.styleElement=e.fetchElement(this.styleElement);var d=this,v=this.container?e.fetchElement(this.container):document.getElementsByTagName("body")[0],m=3;if(e.isElementType(this.targetElement,"button"))if(this.targetElement.onclick){var g=this.targetElement.onclick;this.targetElement.onclick=function(e){return g.call(this,e),!1}}else this.targetElement.onclick=function(){return!1};if(this.valueElement&&e.isElementType(this.valueElement,"input")){var y=function(){d.fromString(d.valueElement.value,e.leaveValue),e.dispatchFineChange(d)};e.attachEvent(this.valueElement,"keyup",y),e.attachEvent(this.valueElement,"input",y),e.attachEvent(this.valueElement,"blur",c),this.valueElement.setAttribute("autocomplete","off")}this.styleElement&&(this.styleElement._jscOrigStyle={backgroundImage:this.styleElement.style.backgroundImage,backgroundColor:this.styleElement.style.backgroundColor,color:this.styleElement.style.color}),this.value?this.fromString(this.value)||this.exportColor():this.importColor()}};return e.jscolor.lookupClass="jscolor",e.jscolor.installByClassName=function(t){var n=document.getElementsByTagName("input"),r=document.getElementsByTagName("button");e.tryInstallOnElements(n,t),e.tryInstallOnElements(r,t)},e.register(),e.jscolor}());window.addEventListener("load",eventWindowLoaded,false);function eventWindowLoaded(){canvasApp()}function canvasSupport(e){return!!e.getContext}function canvasApp(){$("loading_div").show();interfaceInitialization();if(!canvasSupport(grid_canvas)){return}socket=io();bindSocketListeners();bindEventHandlers()}function interfaceInitialization(){grid_canvas=document.getElementById("grid_canvas");underlay_canvas=document.getElementById("underlay_canvas");overlay_canvas=document.getElementById("overlay_canvas");temporary_drawing_canvas=document.getElementById("temporary_drawing_canvas");start_new_line_button=document.getElementById("start_new_line_button");$("#movement_controls").hide();$("#reset_board_button").prop("disabled",true);$("#start_new_line_button").hide();$("#lost_connection_div").hide();ctx=grid_canvas.getContext("2d");ctx2=underlay_canvas.getContext("2d");overlay_ctx=overlay_canvas.getContext("2d");temporary_drawing_ctx=temporary_drawing_canvas.getContext("2d");grid_canvas.width=grid_size*grid_count_width+2*grid_line_width;grid_canvas.height=grid_size*grid_count_height+2*grid_line_width;underlay_canvas.width=grid_size*grid_count_width+2*grid_line_width;underlay_canvas.height=grid_size*grid_count_height+2*grid_line_width;overlay_canvas.width=grid_size*grid_count_width+2*grid_line_width;overlay_canvas.height=grid_size*grid_count_height+2*grid_line_width;temporary_drawing_canvas.width=grid_size*grid_count_width+2*grid_line_width;temporary_drawing_canvas.height=grid_size*grid_count_height+2*grid_line_width;cPosX=window.innerWidth-grid_canvas.width<0?0:Math.ceil((window.innerWidth-grid_canvas.width)/2);cPosY=window.innerHeight-grid_canvas.height<60?60:Math.ceil((window.innerHeight-grid_canvas.height)/2);grid_canvas.style.transform="translate("+cPosX+"px,"+cPosY+"px)";underlay_canvas.style.transform="translate("+cPosX+"px,"+cPosY+"px)";overlay_canvas.style.transform="translate("+cPosX+"px,"+cPosY+"px)";temporary_drawing_canvas.style.transform="translate("+cPosX+"px,"+cPosY+"px)";document.getElementById("ruler_left").style.transform="translate("+(cPosX-20<0?0:cPosX-20)+"px,"+cPosY+"px)";document.getElementById("ruler_top").style.transform="translate("+cPosX+"px,"+(cPosY-20<40?40:cPosY-20)+"px)";var hammer=new Hammer(document.getElementById("grid_canvas_scrolling_container"),null);var overlay_canvas_hammer=new Hammer(document.getElementById("overlay_canvas"),null);var tab_row=new Hammer(document.getElementById("tab_row"),null);overlay_canvas_hammer.get("pinch").set({enable:true});hammer.on("pan",function(evt){cPosX+=Math.ceil(evt.deltaX*.03);cPosY+=Math.ceil(evt.deltaY*.03);grid_canvas.style.transform="translate("+cPosX+"px,"+cPosY+"px)";underlay_canvas.style.transform="translate("+cPosX+"px,"+cPosY+"px)";overlay_canvas.style.transform="translate("+cPosX+"px,"+cPosY+"px)";temporary_drawing_canvas.style.transform="translate("+cPosX+"px,"+cPosY+"px)";document.getElementById("ruler_left").style.transform="translate("+(cPosX-20<0?0:cPosX-20)+"px,"+cPosY+"px)";document.getElementById("ruler_top").style.transform="translate("+cPosX+"px,"+(cPosY-20<40?40:cPosY-20)+"px)"});hammer.on("swipe",function(evt){console.log(evt)});hammer.on("tap",function(evt){console.log(evt)});overlay_canvas_hammer.on("tap",function(evt){console.log(evt);canvasClicked(evt.center.x-$("#overlay_canvas").offset().left,evt.center.y-$("#overlay_canvas").offset().top)});overlay_canvas_hammer.on("pinch",function(evt){console.log(evt);underlay_canvas.style.transform="scale(0.5,0.5)"});tab_row.on("pan",function(evt){$("#tab_row").scrollLeft($("#tab_row").scrollLeft()-50*(evt.deltaX/$("#tab_row")[0].scrollWidth))});drawTopRuler();drawLeftRuler();drawScreen()}function pixel2GridPoint(raw_location){return 1+(raw_location-raw_location%grid_size)/grid_size}function gridPoint2Pixel(grid_point){return(grid_point-1)*grid_size}function isUndefined(value){return value===undefined}function error_report(status,error){console.log("Error: "+status.status+", "+error)}